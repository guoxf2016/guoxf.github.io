<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Something">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Something">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Something">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Something</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Something</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/16/Camera-provider-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/16/Camera-provider-service/" itemprop="url">
                  Camera provider service
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-16 20:19:08 / Modified: 20:24:10" itemprop="dateCreated datePublished" datetime="2019-03-16T20:19:08+08:00">2019-03-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Camera-provider-Service-启动流程"><a href="#Camera-provider-Service-启动流程" class="headerlink" title="Camera provider Service 启动流程"></a>Camera provider Service 启动流程</h3><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>本文整理Camera Provider Service的启动流程，代码基于Android8.x。</p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>启动脚本<br><a href="mailto:android.hardware.camera.provider@2.4-service.rc" target="_blank" rel="noopener">android.hardware.camera.provider@2.4-service.rc</a><br>会执行可执行程序<a href="mailto:/vendor/bin/hw/android.hardware.camera.provider@2.4-service" target="_blank" rel="noopener">/vendor/bin/hw/android.hardware.camera.provider@2.4-service</a><br>对应的main函数在hardware/interfaces/camera/provider/2.4/default/service.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The camera HAL may communicate to other vendor components via</span></span><br><span class="line">    <span class="comment">// /dev/vndbinder</span></span><br><span class="line">    android::ProcessState::initWithDriver(<span class="string">"/dev/vndbinder"</span>);</span><br><span class="line">    <span class="keyword">return</span> defaultPassthroughServiceImplementation&lt;ICameraProvider&gt;(<span class="string">"legacy/0"</span>, <span class="comment">/*maxThreads*/</span> <span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>initWithDriver是binder相关的初始化，会打开binder设备，mmap。<br>注意这里的ProcessState是android namespace 下面的， 也就是frameworks/native/libs/binder/include/binder/ProcessState.h声明的类。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">defaultPassthroughServiceImplementation</span>(<span class="title">std</span>:</span>:<span class="built_in">string</span> name,</span><br><span class="line">                                            <span class="keyword">size_t</span> maxThreads = <span class="number">1</span>) &#123;</span><br><span class="line">    configureRpcThreadpool(maxThreads, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">status_t</span> result = registerPassthroughServiceImplementation&lt;Interface&gt;(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    joinRpcThreadpool();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>///dev/hwbinder<br>configureRpcThreadpool设置binder线程池大小，这里会打开另一个binder设备/dev/hwbinder，并mmap。<br>因为又初始化了一个ProcessState，但是这个ProcessState是在system/libhwbinder/include/hwbinder/ProcessState.h中声明，它的namespace是android::hardware。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">registerPassthroughServiceImplementation</span>(</span></span><br><span class="line"><span class="class">        <span class="title">std</span>:</span>:<span class="built_in">string</span> name = <span class="string">"default"</span>) &#123;</span><br><span class="line">    sp&lt;Interface&gt; service = Interface::getService(name, <span class="literal">true</span> <span class="comment">/* getStub */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> status = service-&gt;registerAsService(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ICameraProvider::getService代码在out/soong/.intermediates/hardware/interfaces/camera/provider/2.4/android.hardware.camera.provider@2.4_genc++/gen/android/hardware/camera/provider/2.4/CameraProviderAll.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">::android::sp&lt;ICameraProvider&gt; ICameraProvider::getService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName, <span class="keyword">const</span> <span class="keyword">bool</span> getStub) &#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::defaultServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::details::waitForHwService;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line">    <span class="keyword">using</span> ::android::sp;</span><br><span class="line">    <span class="keyword">using</span> Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;ICameraProvider&gt; iface = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"getService: defaultServiceManager() is null"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;getTransport(ICameraProvider::descriptor, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!transportRet.isOk()) &#123;</span><br><span class="line">        ALOGE(<span class="string">"getService: defaultServiceManager()-&gt;getTransport returns %s"</span>, transportRet.description().c_str());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;<span class="comment">//getStub == true</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(ICameraProvider::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = ICameraProvider::castFrom(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> BsCameraProvider(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getService实际上返回了ICameraProvider实例。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">::android::<span class="keyword">status_t</span> ICameraProvider::registerAsService(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName) &#123;</span><br><span class="line">    ::android::hardware::details::onRegistration(<span class="string">"android.hardware.camera.provider@2.4"</span>, <span class="string">"ICameraProvider"</span>, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm</span><br><span class="line">            = ::android::hardware::defaultServiceManager();</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; ret = sm-&gt;add(serviceName.c_str(), <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> ret.isOk() &amp;&amp; ret ? ::android::OK : ::android::UNKNOWN_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从sm-&gt;add 的代码来看，什么都没做。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Return&lt;<span class="keyword">bool</span>&gt; add(<span class="keyword">const</span> hidl_string&amp; <span class="comment">/* name */</span>,</span><br><span class="line">                 <span class="keyword">const</span> sp&lt;IBase&gt;&amp; <span class="comment">/* service */</span>) override &#123;</span><br><span class="line">    LOG(FATAL) &lt;&lt; <span class="string">"Cannot register services with passthrough service manager."</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>暂时不理解passthrough是什么意思。<br>回到defaultPassthroughServiceImplementation，最后要调用joinRpcThreadpool。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">joinBinderRpcThreadpool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> IPCThreadState::joinThreadPool(<span class="keyword">bool</span> isMain)<span class="comment">//isMain == true</span></span><br><span class="line">&#123;</span><br><span class="line">    mOut.writeInt32(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result;</span><br><span class="line">    <span class="comment">//这个循环会不断从binder读取命令并执行</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        processPendingDerefs();</span><br><span class="line">        <span class="comment">// now get the next command to be processed, waiting if necessary</span></span><br><span class="line">        result = getAndExecuteCommand();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line">    mOut.writeInt32(BC_EXIT_LOOPER);</span><br><span class="line">    talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上，ICameraProvider的Server端就启动完成了。<br>似乎registerPassthroughServiceImplementation好像没什么用啊。</p>
<p>具体的实现在hardware/interfaces/camera/provider/2.4/default/CameraProvider.cpp。</p>
<p>再详细看一下getService的逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;<span class="comment">//getStub == true</span></span><br><span class="line">        <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(ICameraProvider::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = ICameraProvider::castFrom(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> BsCameraProvider(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* ICameraProvider::descriptor(<span class="string">"android.hardware.camera.provider@2.4::ICameraProvider"</span>);</span><br></pre></td></tr></table></figure>
<p>这是getStub==true的情况，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IServiceManager1_0&gt; getPassthroughServiceManager() &#123;</span><br><span class="line">    <span class="keyword">return</span> getPassthroughServiceManager1_1();</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;IServiceManager1_1&gt; getPassthroughServiceManager1_1() &#123;</span><br><span class="line">    <span class="keyword">static</span> sp&lt;PassthroughServiceManager&gt; manager(<span class="keyword">new</span> PassthroughServiceManager());</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getPassthroughServiceManager返回了一个PassthroughServiceManager的实例。</p>
<p>serviceName是”legacy/0”。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Return&lt;sp&lt;IBase&gt;&gt; get(<span class="keyword">const</span> hidl_string&amp; fqName,</span><br><span class="line">                      <span class="keyword">const</span> hidl_string&amp; name) override &#123;</span><br><span class="line">    sp&lt;IBase&gt; ret = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    openLibs(fqName, [&amp;](<span class="keyword">void</span>* handle, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;lib, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;sym) &#123;</span><br><span class="line">        IBase* (*generator)(<span class="keyword">const</span> <span class="keyword">char</span>* name);</span><br><span class="line">        *(<span class="keyword">void</span> **)(&amp;generator) = dlsym(handle, sym.c_str());</span><br><span class="line">        <span class="keyword">if</span>(!generator) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span>* error = dlerror();</span><br><span class="line">            LOG(ERROR) &lt;&lt; <span class="string">"Passthrough lookup opened "</span> &lt;&lt; lib</span><br><span class="line">                       &lt;&lt; <span class="string">" but could not find symbol "</span> &lt;&lt; sym &lt;&lt; <span class="string">": "</span></span><br><span class="line">                       &lt;&lt; (error == <span class="literal">nullptr</span> ? <span class="string">"unknown error"</span> : error);</span><br><span class="line">            dlclose(handle);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = (*generator)(name.c_str());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            dlclose(handle);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// this module doesn't provide this instance name</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        registerReference(fqName, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用openLibs传入了一个lambda函数。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fqName == "android.hardware.camera.provider@2.4::ICameraProvider"</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">openLibs</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; fqName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="built_in">std</span>::function&lt;<span class="keyword">bool</span> <span class="comment">/* continue */</span>(<span class="keyword">void</span>* <span class="comment">/* handle */</span>,</span></span></span><br><span class="line">                const std::string&amp; /* lib */, const std::string&amp; /* sym */)&gt; eachLib) &#123;</span><br><span class="line">        <span class="comment">//fqName looks like android.hardware.foo@1.0::IFoo</span></span><br><span class="line">        <span class="keyword">size_t</span> idx = fqName.find(<span class="string">"::"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> packageAndVersion = fqName.substr(<span class="number">0</span>, idx);<span class="comment">//"android.hardware.camera.provider@2.4"</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ifaceName = fqName.substr(idx + <span class="built_in">strlen</span>(<span class="string">"::"</span>));<span class="comment">//"ICameraProvider"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> prefix = packageAndVersion + <span class="string">"-impl"</span>;</span><br><span class="line">    <span class="comment">//"android.hardware.camera.provider@2.4-impl"</span></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> sym = <span class="string">"HIDL_FETCH_"</span> + ifaceName;<span class="comment">//"HIDL_FETCH_ICameraProvider"</span></span><br><span class="line">        <span class="comment">//#define RTLD_LAZY     0x00001</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> dlMode = RTLD_LAZY;</span><br><span class="line">        <span class="keyword">void</span> *handle = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        dlerror(); <span class="comment">// clear</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; paths = &#123;HAL_LIBRARY_PATH_ODM, HAL_LIBRARY_PATH_VENDOR,</span><br><span class="line">                                          HAL_LIBRARY_PATH_VNDK_SP, HAL_LIBRARY_PATH_SYSTEM&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LIBHIDL_TARGET_DEBUGGABLE</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* env = <span class="built_in">std</span>::getenv(<span class="string">"TREBLE_TESTING_OVERRIDE"</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> trebleTestingOverride = env &amp;&amp; !<span class="built_in">strcmp</span>(env, <span class="string">"true"</span>);</span><br><span class="line">        <span class="keyword">if</span> (trebleTestingOverride) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span>* vtsRootPath = <span class="built_in">std</span>::getenv(<span class="string">"VTS_ROOT_PATH"</span>);</span><br><span class="line">            <span class="keyword">if</span> (vtsRootPath &amp;&amp; <span class="built_in">strlen</span>(vtsRootPath) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> halLibraryPathVtsOverride =</span><br><span class="line">                    <span class="built_in">std</span>::<span class="built_in">string</span>(vtsRootPath) + HAL_LIBRARY_PATH_SYSTEM;</span><br><span class="line">                paths.push_back(halLibraryPathVtsOverride);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path : paths) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; libs = search(path, prefix, <span class="string">".so"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;lib : libs) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> fullPath = path + lib;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (path != HAL_LIBRARY_PATH_SYSTEM) &#123;</span><br><span class="line">                    handle = android_load_sphal_library(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    handle = dlopen(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">char</span>* error = dlerror();</span><br><span class="line">                    LOG(ERROR) &lt;&lt; <span class="string">"Failed to dlopen "</span> &lt;&lt; lib &lt;&lt; <span class="string">": "</span></span><br><span class="line">                               &lt;&lt; (error == <span class="literal">nullptr</span> ? <span class="string">"unknown error"</span> : error);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!eachLib(handle, lib, sym)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>openLibs主要就是在一些路径下面搜索<a href="mailto:android.hardware.camera.provider@2.4-impl.so" target="_blank" rel="noopener">android.hardware.camera.provider@2.4-impl.so</a>，找到后打开，然后回调上面传入的lambda函数。<br>大概的意思是<br>通过dlopen打开动态库并拿到句柄，通过dlsym找到HIDL_FETCH_ICameraProvider函数的地址，然后调用这个函数，传入的参数是”legacy/0”。<br>hardware/interfaces/camera/provider/2.4/default/CameraProvider.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ICameraProvider* <span class="title">HIDL_FETCH_ICameraProvider</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, kLegacyProviderName) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CameraProvider* provider = <span class="keyword">new</span> CameraProvider();</span><br><span class="line">    <span class="keyword">return</span> provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建CameraProvider， 初始化然后返回它。<br>所以ICameraProvider::getService在通过PassthroughServiceManager的get函数得到的是一个CameraProvider实例。最后再cast。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iface = ICameraProvider::castFrom(baseInterface);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::android::hardware::Return&lt;::android::sp&lt;ICameraProvider&gt;&gt; ICameraProvider::castFrom(<span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; parent, <span class="keyword">bool</span> emitError) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::details::castInterface&lt;ICameraProvider, ::android::hidl::base::V1_0::IBase, BpHwCameraProvider&gt;(</span><br><span class="line">            parent, <span class="string">"android.hardware.camera.provider@2.4::ICameraProvider"</span>, emitError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> IChild, <span class="keyword">typename</span> IParent, <span class="keyword">typename</span> BpChild&gt;</span><br><span class="line">Return&lt;sp&lt;IChild&gt;&gt; castInterface(sp&lt;IParent&gt; parent, <span class="keyword">const</span> <span class="keyword">char</span>* childIndicator, <span class="keyword">bool</span> emitError) &#123;</span><br><span class="line">   <span class="keyword">if</span> (parent-&gt;isRemote()) &#123;<span class="comment">//false</span></span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">new</span> BpChild(toBinder&lt;IParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">static_cast</span>&lt;IChild *&gt;(parent.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraProvider的指针static_cast为ICameraProvider指针。</p>
<p>Frameworks层的CameraService会调用ICameraProvider的接口，其服务端的实现就是CameraProvider。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>ICameraProvider启动会打开binder设备，并且进入循环，从binder中读取Client端发来的命令并且执行，它的业务逻辑的实现在CameraProvider中，Client端就是Frameworks的CameraService进程。CameraService在启动时会getI到CameraProvider的代理保存在ProviderInfo中。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/16/Camera2-preview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/16/Camera2-preview/" itemprop="url">
                  Camera2 preview
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-16 20:13:30 / Modified: 20:24:05" itemprop="dateCreated datePublished" datetime="2019-03-16T20:13:30+08:00">2019-03-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Camera2-preview"><a href="#Camera2-preview" class="headerlink" title="Camera2 preview"></a>Camera2 preview</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>本文主要分析Camera2 的preview流程，代码基于Android8.x。</p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>在CameraManager调用openCamera成功打开相机设备后，应用传入的CameraDevice.StateCallback会被回调onOpened方法，在onOpened中创建session<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);<span class="comment">//返回CaptureRequest.Builder</span></span><br><span class="line">cameraDevice.createCaptureSession(list, captureSessionCallback, mCameraHandler);</span><br><span class="line"><span class="comment">//list的元素是Surface， captureSessionCallback是CameraCaptureSession.StateCallback</span></span><br></pre></td></tr></table></figure></p>
<p>templateType 有几种：</p>
<pre><code>* @see #TEMPLATE_PREVIEW　//预览
* @see #TEMPLATE_RECORD　// 录像
* @see #TEMPLATE_STILL_CAPTURE　//拍照
* @see #TEMPLATE_VIDEO_SNAPSHOT//录像中拍照
* @see #TEMPLATE_MANUAL //手动？
</code></pre><p>framworks/base/core/java/android/hardware/camera2/impl/CameraDeviceImpl.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CaptureRequest.<span class="function">Builder <span class="title">createCaptureRequest</span><span class="params">(<span class="keyword">int</span> templateType)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line"></span><br><span class="line">        CameraMetadataNative templatedRequest = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        templatedRequest = mRemoteDevice.createDefaultRequest(templateType);</span><br><span class="line"></span><br><span class="line">        CaptureRequest.Builder builder = <span class="keyword">new</span> CaptureRequest.Builder(</span><br><span class="line">                templatedRequest, <span class="comment">/*reprocess*/</span><span class="keyword">false</span>, CameraCaptureSession.SESSION_ID_NONE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mRemoteDevice是ICameraDeviceUser的Bp端，根据上一篇分析的openCamera，Bn端是CameraDeviceClient。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">binder::Status CameraDeviceClient::createDefaultRequest(<span class="keyword">int</span> templateId,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        hardware::camera2::impl::CameraMetadataNative* request)</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">icl</span><span class="params">(mBinderSerializationLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    CameraMetadata metadata;</span><br><span class="line">    <span class="keyword">status_t</span> err;</span><br><span class="line">    <span class="comment">//mDevice是Camera3Device</span></span><br><span class="line">    <span class="keyword">if</span> ( (err = mDevice-&gt;createDefaultRequest(templateId, &amp;metadata) ) == OK &amp;&amp;</span><br><span class="line">        request != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        request-&gt;swap(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将调用传递到Camera3Deivce。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::createDefaultRequest(<span class="keyword">int</span> templateId,</span><br><span class="line">        CameraMetadata *request) &#123;</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">il</span><span class="params">(mInterfaceLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        <span class="comment">//先总缓存中取</span></span><br><span class="line">        <span class="keyword">if</span> (!mRequestTemplateCache[templateId].isEmpty()) &#123;</span><br><span class="line">            *request = mRequestTemplateCache[templateId];</span><br><span class="line">            <span class="keyword">return</span> OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">camera_metadata_t</span> *rawRequest;</span><br><span class="line">    <span class="keyword">status_t</span> res = mInterface-&gt;constructDefaultRequestSettings(</span><br><span class="line">            (<span class="keyword">camera3_request_template_t</span>) templateId, &amp;rawRequest);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        set_camera_metadata_vendor_id(rawRequest, mVendorTagId);</span><br><span class="line">        <span class="comment">//缓存</span></span><br><span class="line">        mRequestTemplateCache[templateId].acquire(rawRequest);</span><br><span class="line"></span><br><span class="line">        *request = mRequestTemplateCache[templateId];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>传递到Hal层<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::HalInterface::constructDefaultRequestSettings(</span><br><span class="line">        <span class="keyword">camera3_request_template_t</span> templateId,</span><br><span class="line">        <span class="comment">/*out*/</span> <span class="keyword">camera_metadata_t</span> **requestTemplate) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res = OK;</span><br><span class="line">    common::V1_0::Status status;</span><br><span class="line">    RequestTemplate id;</span><br><span class="line">    <span class="keyword">switch</span> (templateId) &#123;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_PREVIEW:</span><br><span class="line">            id = RequestTemplate::PREVIEW;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_STILL_CAPTURE:</span><br><span class="line">            id = RequestTemplate::STILL_CAPTURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_VIDEO_RECORD:</span><br><span class="line">            id = RequestTemplate::VIDEO_RECORD;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_VIDEO_SNAPSHOT:</span><br><span class="line">            id = RequestTemplate::VIDEO_SNAPSHOT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_ZERO_SHUTTER_LAG:</span><br><span class="line">            id = RequestTemplate::ZERO_SHUTTER_LAG;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CAMERA3_TEMPLATE_MANUAL:</span><br><span class="line">            id = RequestTemplate::MANUAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Unknown template ID</span></span><br><span class="line">            <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> err = mHidlSession-&gt;constructDefaultRequestSettings(id,</span><br><span class="line">            [&amp;status, &amp;requestTemplate]</span><br><span class="line">            (common::V1_0::Status s, <span class="keyword">const</span> device::V3_2::CameraMetadata&amp; request) &#123;</span><br><span class="line">                status = s;</span><br><span class="line">                <span class="keyword">if</span> (status == common::V1_0::Status::OK) &#123;</span><br><span class="line">                    <span class="keyword">const</span> camera_metadata *r =</span><br><span class="line">                            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">camera_metadata_t</span>*&gt;(request.data());</span><br><span class="line">                    <span class="keyword">size_t</span> expectedSize = request.size();</span><br><span class="line">                    <span class="keyword">int</span> ret = validate_camera_metadata_structure(r, &amp;expectedSize);</span><br><span class="line">                    <span class="keyword">if</span> (ret == OK || ret == CAMERA_METADATA_VALIDATION_SHIFTED) &#123;</span><br><span class="line">                        *requestTemplate = clone_camera_metadata(r);</span><br><span class="line">                        <span class="keyword">if</span> (*requestTemplate == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                            ALOGE(<span class="string">"%s: Unable to clone camera metadata received from HAL"</span>,</span><br><span class="line">                                    __FUNCTION__);</span><br><span class="line">                            status = common::V1_0::Status::INTERNAL_ERROR;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ALOGE(<span class="string">"%s: Malformed camera metadata received from HAL"</span>, __FUNCTION__);</span><br><span class="line">                        status = common::V1_0::Status::INTERNAL_ERROR;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//mHidlSession是初始化时打开的与Hal层的一个Session</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里不继续往下展开，只知道请求hal创建了一个camera_metadata_t的数据。将他包装进CameraMetadata，返回给应用端。应用端用它new CaptureRequest.Builder。实际上会new一个CaptureRequest，保存了CameraMetadata。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCaptureSession</span><span class="params">(List&lt;Surface&gt; outputs,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraCaptureSession.StateCallback callback, Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    List&lt;OutputConfiguration&gt; outConfigurations = <span class="keyword">new</span> ArrayList&lt;&gt;(outputs.size());</span><br><span class="line">    <span class="keyword">for</span> (Surface surface : outputs) &#123;</span><br><span class="line">        outConfigurations.add(<span class="keyword">new</span> OutputConfiguration(surface));</span><br><span class="line">    &#125;</span><br><span class="line">    createCaptureSessionInternal(<span class="keyword">null</span>, outConfigurations, callback, handler,</span><br><span class="line">            <span class="comment">/*operatingMode*/</span>ICameraDeviceUser.NORMAL_MODE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createCaptureSessionInternal</span><span class="params">(InputConfiguration inputConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;OutputConfiguration&gt; outputConfigurations,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraCaptureSession.StateCallback callback, Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> operatingMode)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">        <span class="comment">//省略部分代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fire onConfigured if configureOutputs succeeded, fire onConfigureFailed otherwise.</span></span><br><span class="line">        CameraCaptureSessionCore newSession = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isConstrainedHighSpeed) &#123;</span><br><span class="line">            newSession = <span class="keyword">new</span> CameraConstrainedHighSpeedCaptureSessionImpl(mNextSessionId++,</span><br><span class="line">                    callback, handler, <span class="keyword">this</span>, mDeviceHandler, configureSuccess,</span><br><span class="line">                    mCharacteristics);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//普通模式</span></span><br><span class="line">            newSession = <span class="keyword">new</span> CameraCaptureSessionImpl(mNextSessionId++, input,</span><br><span class="line">                    callback, handler, <span class="keyword">this</span>, mDeviceHandler,</span><br><span class="line">                    configureSuccess);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> wait until current session closes, then create the new session</span></span><br><span class="line">        mCurrentSession = newSession;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pendingException != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> pendingException;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mSessionStateCallback = mCurrentSession.getDeviceStateCallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>new了一个CameraCaptureSessionImpl对象，CameraCaptureSessionImpl.java和CameraDeviceImpl.java在相同目录。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">CameraCaptureSessionImpl(<span class="keyword">int</span> id, Surface input,</span><br><span class="line">            CameraCaptureSession.StateCallback callback, Handler stateHandler,</span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl,</span><br><span class="line">            Handler deviceStateHandler, <span class="keyword">boolean</span> configureSuccess) &#123;</span><br><span class="line"></span><br><span class="line">        mId = id;</span><br><span class="line">        mIdString = String.format(<span class="string">"Session %d: "</span>, mId);</span><br><span class="line"></span><br><span class="line">        mInput = input;</span><br><span class="line">        mStateHandler = checkHandler(stateHandler);</span><br><span class="line">        mStateCallback = createUserStateCallbackProxy(mStateHandler, callback);</span><br><span class="line"></span><br><span class="line">        mDeviceHandler = checkNotNull(deviceStateHandler, <span class="string">"deviceStateHandler must not be null"</span>);</span><br><span class="line">        mDeviceImpl = checkNotNull(deviceImpl, <span class="string">"deviceImpl must not be null"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Use the same handler as the device's StateCallback for all the internal coming events</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This ensures total ordering between CameraDevice.StateCallback and</span></span><br><span class="line"><span class="comment">         * CameraDeviceImpl.CaptureCallback events.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        mSequenceDrainer = <span class="keyword">new</span> TaskDrainer&lt;&gt;(mDeviceHandler, <span class="keyword">new</span> SequenceDrainListener(),</span><br><span class="line">                <span class="comment">/*name*/</span><span class="string">"seq"</span>);</span><br><span class="line">        mIdleDrainer = <span class="keyword">new</span> TaskSingleDrainer(mDeviceHandler, <span class="keyword">new</span> IdleDrainListener(),</span><br><span class="line">                <span class="comment">/*name*/</span><span class="string">"idle"</span>);</span><br><span class="line">        mAbortDrainer = <span class="keyword">new</span> TaskSingleDrainer(mDeviceHandler, <span class="keyword">new</span> AbortDrainListener(),</span><br><span class="line">                <span class="comment">/*name*/</span><span class="string">"abort"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CameraDevice should call configureOutputs and have it finish before constructing us</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (configureSuccess) &#123;</span><br><span class="line">            <span class="comment">//这里会回调createCaptureSession传入的CameraCaptureSession.StateCallback的onConfigured方法，不是直接调用，用到了反射，不清楚这样做的原因。</span></span><br><span class="line">            mStateCallback.onConfigured(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, mIdString + <span class="string">"Created session successfully"</span>);</span><br><span class="line">            mConfigureSuccess = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mStateCallback.onConfigureFailed(<span class="keyword">this</span>);</span><br><span class="line">            mClosed = <span class="keyword">true</span>; <span class="comment">// do not fire any other callbacks, do not allow any other work</span></span><br><span class="line">            Log.e(TAG, mIdString + <span class="string">"Failed to create capture session; configuration failed"</span>);</span><br><span class="line">            mConfigureSuccess = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在onConfigured回调中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cameraCaptureSession.setRepeatingRequest(captureRequest, capturecallback, handler);</span><br></pre></td></tr></table></figure></p>
<p>captureRequest就是一开始CameraDevice.createCaptureRequest返回的CaptureRequest.Builder.build()创建的，captureCallback是CameraCaptureSession.CaptureCallback。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setRepeatingRequest</span><span class="params">(CaptureRequest request, CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mDeviceImpl.mInterfaceLock) &#123;</span><br><span class="line">        checkNotClosed();</span><br><span class="line"></span><br><span class="line">        handler = checkHandler(handler, callback);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.v(TAG, mIdString + <span class="string">"setRepeatingRequest - request "</span> + request + <span class="string">", callback "</span> +</span><br><span class="line">                    callback + <span class="string">" handler"</span> + <span class="string">" "</span> + handler);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> addPendingSequence(mDeviceImpl.setRepeatingRequest(request,</span><br><span class="line">                createCaptureCallbackProxy(handler, callback), mDeviceHandler));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用CameraDeviceImpl的setRepeatingRequest, 再调用submitCaptureRequest<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setRepeatingRequest</span><span class="params">(CaptureRequest request, CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler handler)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    List&lt;CaptureRequest&gt; requestList = <span class="keyword">new</span> ArrayList&lt;CaptureRequest&gt;();</span><br><span class="line">    requestList.add(request);</span><br><span class="line">    <span class="keyword">return</span> submitCaptureRequest(requestList, callback, handler, <span class="comment">/*streaming*/</span><span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">submitCaptureRequest</span><span class="params">(List&lt;CaptureRequest&gt; requestList, CaptureCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">            Handler handler, <span class="keyword">boolean</span> repeating)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="comment">//省略部分代码</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line">            <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">                stopRepeating();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SubmitInfo requestInfo;</span><br><span class="line"></span><br><span class="line">            CaptureRequest[] requestArray = requestList.toArray(<span class="keyword">new</span> CaptureRequest[requestList.size()]);</span><br><span class="line">            <span class="comment">//IPC 调用CameraDeviceClient</span></span><br><span class="line">            requestInfo = mRemoteDevice.submitRequestList(requestArray, repeating);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> requestInfo.getRequestId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">binder::Status CameraDeviceClient::submitRequestList(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;hardware::camera2::CaptureRequest&gt;&amp; requests,</span><br><span class="line">        <span class="keyword">bool</span> streaming,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        hardware::camera2::utils::SubmitInfo *submitInfo) &#123;</span><br><span class="line"></span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">icl</span><span class="params">(mBinderSerializationLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    List&lt;<span class="keyword">const</span> CameraMetadata&gt; metadataRequestList;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; surfaceMapList;</span><br><span class="line">    submitInfo-&gt;mRequestId = mRequestIdCounter;</span><br><span class="line">    <span class="keyword">uint32_t</span> loopCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; request: requests) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="function">CameraMetadata <span class="title">metadata</span><span class="params">(request.mMetadata)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Write in the output stream IDs and map from stream ID to surface ID</span></span><br><span class="line"><span class="comment">         * which we calculate from the capture request's list of surface target</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        SurfaceMap surfaceMap;</span><br><span class="line">        Vector&lt;<span class="keyword">int32_t</span>&gt; outputStreamIds;</span><br><span class="line">        <span class="keyword">for</span> (sp&lt;Surface&gt; surface : request.mSurfaceList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (surface == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            sp&lt;IGraphicBufferProducer&gt; gbp = surface-&gt;getIGraphicBufferProducer();</span><br><span class="line">            <span class="keyword">int</span> idx = mStreamMap.indexOfKey(IInterface::asBinder(gbp));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> StreamSurfaceId&amp; streamSurfaceId = mStreamMap.valueAt(idx);</span><br><span class="line">            <span class="keyword">if</span> (surfaceMap.find(streamSurfaceId.streamId()) == surfaceMap.end()) &#123;</span><br><span class="line">                surfaceMap[streamSurfaceId.streamId()] = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt;();</span><br><span class="line">                outputStreamIds.push_back(streamSurfaceId.streamId());</span><br><span class="line">            &#125;</span><br><span class="line">            surfaceMap[streamSurfaceId.streamId()].push_back(streamSurfaceId.surfaceId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        metadata.update(ANDROID_REQUEST_OUTPUT_STREAMS, &amp;outputStreamIds[<span class="number">0</span>],</span><br><span class="line">                        outputStreamIds.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.mIsReprocess) &#123; <span class="comment">//preview false</span></span><br><span class="line">            metadata.update(ANDROID_REQUEST_INPUT_STREAMS, &amp;mInputStream.id, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        metadata.update(ANDROID_REQUEST_ID, &amp;(submitInfo-&gt;mRequestId), <span class="comment">/*size*/</span><span class="number">1</span>);</span><br><span class="line">        loopCounter++; <span class="comment">// loopCounter starts from 1</span></span><br><span class="line"></span><br><span class="line">        metadataRequestList.push_back(metadata);</span><br><span class="line">        surfaceMapList.push_back(surfaceMap);</span><br><span class="line">    &#125;</span><br><span class="line">    mRequestIdCounter++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (streaming) &#123;</span><br><span class="line">        err = mDevice-&gt;setStreamingRequestList(metadataRequestList, surfaceMapList,</span><br><span class="line">                &amp;(submitInfo-&gt;mLastFrameNumber));</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Mutex::Autolock idLock(mStreamingRequestIdLock);</span><br><span class="line">            mStreamingRequestId = submitInfo-&gt;mRequestId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = mDevice-&gt;captureList(metadataRequestList, surfaceMapList,</span><br><span class="line">                &amp;(submitInfo-&gt;mLastFrameNumber));</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对Request做一定处理后交个hal</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::setStreamingRequest(<span class="keyword">const</span> CameraMetadata &amp;request,</span><br><span class="line">                                            <span class="keyword">int64_t</span>* <span class="comment">/*lastFrameNumber*/</span>) &#123;</span><br><span class="line">    List&lt;<span class="keyword">const</span> CameraMetadata&gt; requests;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; surfaceMaps;</span><br><span class="line">    convertToRequestList(requests, surfaceMaps, request);</span><br><span class="line">    <span class="keyword">return</span> setStreamingRequestList(requests, <span class="comment">/*surfaceMap*/</span>surfaceMaps,</span><br><span class="line">                                   <span class="comment">/*lastFrameNumber*/</span><span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::submitRequestsHelper(</span><br><span class="line">        <span class="keyword">const</span> List&lt;<span class="keyword">const</span> CameraMetadata&gt; &amp;requests,</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">list</span>&lt;<span class="keyword">const</span> SurfaceMap&gt; &amp;surfaceMaps,</span><br><span class="line">        <span class="keyword">bool</span> repeating,<span class="comment">//true</span></span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        <span class="keyword">int64_t</span> *lastFrameNumber) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">il</span><span class="params">(mInterfaceLock)</span></span>;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    RequestList requestList;</span><br><span class="line">    <span class="comment">//创建CaptureRequest</span></span><br><span class="line">    res = convertMetadataListToRequestListLocked(requests, surfaceMaps,</span><br><span class="line">            repeating, <span class="comment">/*out*/</span>&amp;requestList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (repeating) &#123;</span><br><span class="line">        res = mRequestThread-&gt;setRepeatingRequests(requestList, lastFrameNumber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res = mRequestThread-&gt;queueRequestList(requestList, lastFrameNumber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在RequestThread线程中将Request再转换成camera3_capture_request_t，然后调用Camera3Device::RequestThread::sendRequestsBatch()，里面会调用Camera3Device::HalInterface::processBatchCaptureRequests，<br>再进一步包装Camera3Device::HalInterface::wrapAsHidlRequest成device::V3_2::CaptureRequest，<br>再通过HIDL调用CameraDeviceSession的processCaptureRequest。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> err = mHidlSession-&gt;processCaptureRequest(captureRequests, cachesToRemove,</span><br><span class="line">            [&amp;status, &amp;numRequestProcessed] (<span class="keyword">auto</span> s, <span class="keyword">uint32_t</span> n) &#123;</span><br><span class="line">                status = s;</span><br><span class="line">                *numRequestProcessed = n;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>
<p>hal会调用到QCamera3HardwareInterface::orchestrateRequest，处理请求后要向CameraService返回Result。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QCamera3HardwareInterface::orchestrateResult(</span><br><span class="line">                    <span class="keyword">camera3_capture_result_t</span> *result)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//省略部分代码</span></span><br><span class="line">    result-&gt;frame_number = frameworkFrameNumber;</span><br><span class="line">    mCallbackOps-&gt;process_capture_result(mCallbackOps, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>会调用到CameraDeviceSession::sProcessCaptureResult，然后调用CameraDeviceSession::ResultBatcher::processCaptureResult，然后调用CameraDeviceSession::ResultBatcher::processOneCaptureResult，然后<br>CameraDeviceSession::ResultBatcher::invokeProcessCaptureResultCallback，然后会hidl调用ICameraDeviceCallback的processCaptureResult，传递到CameraServer进程。实际上ICameraDeviceCallback的服务端就是Camera3Device。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hardware::Return&lt;<span class="keyword">void</span>&gt; Camera3Device::processCaptureResult(</span><br><span class="line">        <span class="keyword">const</span> hardware::hidl_vec&lt;</span><br><span class="line">                hardware::camera::device::V3_2::CaptureResult&gt;&amp; results) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; result : results) &#123;</span><br><span class="line">        processOneCaptureResultLocked(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hardware::Void();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在OpenCamera中CameraDeviceClient::initializeImpl函数中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String8 threadName;</span><br><span class="line">   mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">   threadName = String8::format(<span class="string">"CDU-%s-FrameProc"</span>, mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">   mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">   mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">                                     FRAME_PROCESSOR_LISTENER_MAX_ID,</span><br><span class="line">                                     <span class="comment">/*listener*/</span><span class="keyword">this</span>,</span><br><span class="line">                                     <span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>Camera3Device::processCaptureResult会唤醒 mFrameProcessor线程， 并回调onResultAvailable函数。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CameraDeviceClient::onResultAvailable(<span class="keyword">const</span> CaptureResult&amp; result) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Thread-safe. No lock necessary.</span></span><br><span class="line">    sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; remoteCb = mRemoteCallback;</span><br><span class="line">    <span class="keyword">if</span> (remoteCb != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        remoteCb-&gt;onResultReceived(result.mMetadata, result.mResultExtras);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再通过IPC回调应用进程的onResultReceived方法。注意这里hardware::camera2::ICameraDeviceCallbacks和前面说的hardware::camera::device::V3_2::ICameraDeviceCallback是不同的，一个是CameraServer和Hal的IPC接口，一个是CameraServer和应用进程的IPC接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">                    <span class="keyword">final</span> CaptureResult resultAsCapture =</span><br><span class="line">                            <span class="keyword">new</span> CaptureResult(result, request, resultExtras);</span><br><span class="line">                    <span class="comment">// Partial result</span></span><br><span class="line">                    resultDispatch = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (!CameraDeviceImpl.<span class="keyword">this</span>.isClosed()) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">                                    <span class="comment">// Send derived onCaptureProgressed for requests within</span></span><br><span class="line">                                    <span class="comment">// the batch.</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                                        CameraMetadataNative resultLocal =</span><br><span class="line">                                                <span class="keyword">new</span> CameraMetadataNative(resultCopy);</span><br><span class="line">                                        CaptureResult resultInBatch = <span class="keyword">new</span> CaptureResult(</span><br><span class="line">                                                resultLocal, holder.getRequest(i), resultExtras);</span><br><span class="line"></span><br><span class="line">                                        holder.getCallback().onCaptureProgressed(</span><br><span class="line">                                            CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                                            holder.getRequest(i),</span><br><span class="line">                                            resultInBatch);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    holder.getCallback().onCaptureProgressed(</span><br><span class="line">                                        CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                                        request,</span><br><span class="line">                                        resultAsCapture);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    finalResult = resultAsCapture;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;CaptureResult&gt; partialResults =</span><br><span class="line">                            mFrameNumberTracker.popPartialResults(frameNumber);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> sensorTimestamp =</span><br><span class="line">                            result.get(CaptureResult.SENSOR_TIMESTAMP);</span><br><span class="line">                    <span class="keyword">final</span> Range&lt;Integer&gt; fpsRange =</span><br><span class="line">                            request.get(CaptureRequest.CONTROL_AE_TARGET_FPS_RANGE);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> subsequenceId = resultExtras.getSubsequenceId();</span><br><span class="line">                    <span class="keyword">final</span> TotalCaptureResult resultAsCapture = <span class="keyword">new</span> TotalCaptureResult(result,</span><br><span class="line">                            request, resultExtras, partialResults, holder.getSessionId());</span><br><span class="line">                    <span class="comment">// Final capture result</span></span><br><span class="line">                    resultDispatch = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (!CameraDeviceImpl.<span class="keyword">this</span>.isClosed())&#123;</span><br><span class="line">                                <span class="keyword">if</span> (holder.hasBatchedOutputs()) &#123;</span><br><span class="line">                                    <span class="comment">// Send derived onCaptureCompleted for requests within</span></span><br><span class="line">                                    <span class="comment">// the batch.</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; holder.getRequestCount(); i++) &#123;</span><br><span class="line">                                        resultCopy.set(CaptureResult.SENSOR_TIMESTAMP,</span><br><span class="line">                                                sensorTimestamp - (subsequenceId - i) *</span><br><span class="line">                                                NANO_PER_SECOND/fpsRange.getUpper());</span><br><span class="line">                                        CameraMetadataNative resultLocal =</span><br><span class="line">                                                <span class="keyword">new</span> CameraMetadataNative(resultCopy);</span><br><span class="line">                                        TotalCaptureResult resultInBatch = <span class="keyword">new</span> TotalCaptureResult(</span><br><span class="line">                                            resultLocal, holder.getRequest(i), resultExtras,</span><br><span class="line">                                            partialResults, holder.getSessionId());</span><br><span class="line"></span><br><span class="line">                                        holder.getCallback().onCaptureCompleted(</span><br><span class="line">                                            CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                                            holder.getRequest(i),</span><br><span class="line">                                            resultInBatch);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    holder.getCallback().onCaptureCompleted(</span><br><span class="line">                                        CameraDeviceImpl.<span class="keyword">this</span>,</span><br><span class="line">                                        request,</span><br><span class="line">                                        resultAsCapture);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    finalResult = resultAsCapture;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                holder.getHandler().post(resultDispatch);</span><br></pre></td></tr></table></figure>
<p>会回调到onCaptureProgressed或者onCaptureCompleted。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>以上就是Camera2的preview流程，中间省略了很多复杂的细节，大体的架构跟openCamera是一样的，还是应用进程，CameraServer进程和Hal进程3层的交互。请求是有应用发给CameraServer再由CameraServer发给Hal，Result则是相反的顺序。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/Camera2-Open源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/Camera2-Open源码分析/" itemprop="url">
                  Camera2 Open源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-16 18:53:15 / Modified: 18:54:16" itemprop="dateCreated datePublished" datetime="2019-02-16T18:53:15+08:00">2019-02-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Camera2-Open"><a href="#Camera2-Open" class="headerlink" title="Camera2 Open"></a>Camera2 Open</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>本文主要分析Camera2 的open流程，代码基于Android8.x</p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>首先看CameraManager的openCamera方法，代码在frameworks/base/core/java/android/hardware/camera2/CameraManager.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresPermission</span>(android.Manifest.permission.CAMERA)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(@NonNull String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull <span class="keyword">final</span> CameraDevice.StateCallback callback, @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">    openCameraForUid(cameraId, callback, handler, USE_CALLING_UID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>传入了3个参数，分别是cameraId，StateCallback，和一个Handler。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCameraForUid</span><span class="params">(@NonNull String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull <span class="keyword">final</span> CameraDevice.StateCallback callback, @Nullable Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> clientUid)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">        <span class="comment">//省略部分代码</span></span><br><span class="line">        openCameraDeviceUserAsync(cameraId, callback, handler, clientUid);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CameraDevice <span class="title">openCameraDeviceUserAsync</span><span class="params">(String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            CameraDevice.StateCallback callback, Handler handler, <span class="keyword">final</span> <span class="keyword">int</span> uid)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">        CameraCharacteristics characteristics = getCameraCharacteristics(cameraId);</span><br><span class="line">        CameraDevice device = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//ICameraDeviceUser定义了Camera应用和CameraServer进程IPC的接口</span></span><br><span class="line">            <span class="comment">//Camera应用是Client，CameraServer是Service</span></span><br><span class="line">            ICameraDeviceUser cameraUser = <span class="keyword">null</span>;</span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                    <span class="keyword">new</span> android.hardware.camera2.impl.CameraDeviceImpl(</span><br><span class="line">                        cameraId,</span><br><span class="line">                        callback,</span><br><span class="line">                        handler,</span><br><span class="line">                        characteristics,</span><br><span class="line">                        mContext.getApplicationInfo().targetSdkVersion);</span><br><span class="line">            <span class="comment">//ICameraDeviceCallbacks同样也是IPC接口，不同的是</span></span><br><span class="line">            <span class="comment">//Camera应用是Service，CameraServer是Client</span></span><br><span class="line">            ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (supportsCamera2ApiLocked(cameraId)) &#123;<span class="comment">//最新的hal支持Camera2 api</span></span><br><span class="line">                    <span class="comment">// Use cameraservice's cameradeviceclient implementation for HAL3.2+ devices</span></span><br><span class="line">                    ICameraService cameraService = CameraManagerGlobal.get().getCameraService();</span><br><span class="line">                    <span class="comment">//跨进程调用，CameraService会调用makeClient打开设备</span></span><br><span class="line">                    <span class="comment">//这里还把callbacks传下去了</span></span><br><span class="line">                    cameraUser = cameraService.connectDevice(callbacks, cameraId,</span><br><span class="line">                            mContext.getOpPackageName(), uid);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Use legacy camera implementation for HAL1 devices</span></span><br><span class="line">                    <span class="keyword">int</span> id;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        id = Integer.parseInt(cameraId);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Expected cameraId to be numeric, but it was: "</span></span><br><span class="line">                                + cameraId);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Log.i(TAG, <span class="string">"Using legacy camera HAL."</span>);</span><br><span class="line">                    cameraUser = CameraDeviceUserShim.connectBinderShim(callbacks, id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> factor out callback to be non-nested, then move setter to constructor</span></span><br><span class="line">            <span class="comment">// For now, calling setRemoteDevice will fire initial</span></span><br><span class="line">            <span class="comment">// onOpened/onUnconfigured callbacks.</span></span><br><span class="line">            <span class="comment">// This function call may post onDisconnected and throw CAMERA_DISCONNECTED if</span></span><br><span class="line">            <span class="comment">// cameraUser dies during setup.</span></span><br><span class="line">            <span class="comment">//CameraService返回的cameraUser和deviceImpl绑定</span></span><br><span class="line">            deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">            device = deviceImpl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> device;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>通过CameraManager.openCamera，Camera应用得到一个CameraDevice实例，它持有一个ICameraDeviceUser的Bp端引用。<br>我们来看一下CameraService的connectDevice函数，代码在frameworks/av/services/camera/libcameraservice/CameraService.cpp<br>跟Camera1的open类似，connectDevice会调用connectHelper，又会调用到makeClient，我们直接看makeClient。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_4:</span><br><span class="line">        <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123; <span class="comment">// Camera1 API route</span></span><br><span class="line">            sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">            *client = <span class="keyword">new</span> Camera2Client(cameraService, tmp, packageName, cameraIdToInt(cameraId),</span><br><span class="line">                    facing, clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">            sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; tmp =</span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;hardware::camera2::ICameraDeviceCallbacks*&gt;(cameraCb.get());</span><br><span class="line">            *client = <span class="keyword">new</span> CameraDeviceClient(cameraService, tmp, packageName, cameraId,</span><br><span class="line">                    facing, clientPid, clientUid, servicePid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们看到Camera1和Camera2的代码是比较类似的，ICameraDeviceCallbacks等同于ICameraClient，CameraDeviceClient等同于Camera2Client。<br>再看继承关系<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraDeviceClient</span> :</span></span><br><span class="line">        <span class="keyword">public</span> Camera2ClientBase&lt;CameraDeviceClientBase&gt;,</span><br><span class="line">        <span class="keyword">public</span> camera2::FrameProcessorBase::FilteredListener&#123;&#125;</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera2Client</span> :</span></span><br><span class="line">        <span class="keyword">public</span> Camera2ClientBase&lt;CameraService::Client&gt;&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>CameraDeviceClient和Camera2Client都继承了Camera2ClientBase，而CameraDeviceClientBase和CameraService::Client都继承了<br>CameraService::BasicClient。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CameraDeviceClientBase</span> :</span></span><br><span class="line">         <span class="keyword">public</span> CameraService::BasicClient,</span><br><span class="line">         <span class="keyword">public</span> hardware::camera2::BnCameraDeviceUser&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> :</span> <span class="keyword">public</span> hardware::BnCamera, <span class="keyword">public</span> BasicClient&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BnCamera</span>:</span> <span class="keyword">public</span> android::BnInterface&lt;ICamera&gt;&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>BnCameraDeviceUser就是ICameraDeviceUser的Bn端，而Camera1的相应的Interface是ICamera。<br>在Camera2ClientBase的构造函数中创建了Camera3Device。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid):</span><br><span class="line">        TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">                cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">        mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">        mDeviceVersion(cameraService-&gt;getDeviceVersion(TClientBase::mCameraIdStr)),</span><br><span class="line">        mDeviceActive(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    mInitialClientPid = clientPid;</span><br><span class="line">    mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以Camera1和Camera2在CameraServer中打开的CameraDevice实际上是相同的。<br>再构造函数之后，会调用CameraDeviceClient::initialize，转而调用CameraDeviceClient::initializeImpl。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> CameraDeviceClient::initializeImpl(TProviderPtr providerPtr) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line"></span><br><span class="line">    res = Camera2ClientBase::initialize(providerPtr);<span class="comment">//这里面会调用Camera3Device的initialize</span></span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这里和Camera1是不同的，这里只开启一个线程，而Camera1中则开启了多个线程</span></span><br><span class="line">    String8 threadName;</span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">"CDU-%s-FrameProc"</span>, mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">                                      FRAME_PROCESSOR_LISTENER_MAX_ID,</span><br><span class="line">                                      <span class="comment">/*listener*/</span><span class="keyword">this</span>,</span><br><span class="line">                                      <span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::initialize(sp&lt;CameraProviderManager&gt; manager) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">il</span><span class="params">(mInterfaceLock)</span></span>;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;ICameraDeviceSession&gt; session;</span><br><span class="line">    <span class="comment">//这里会跟Hal交互打开session</span></span><br><span class="line">    <span class="keyword">status_t</span> res = manager-&gt;openSession(mId.<span class="built_in">string</span>(), <span class="keyword">this</span>,</span><br><span class="line">            <span class="comment">/*out*/</span> &amp;session);</span><br><span class="line"></span><br><span class="line">    res = manager-&gt;getCameraCharacteristics(mId.<span class="built_in">string</span>(), &amp;mDeviceInfo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;RequestMetadataQueue&gt; <span class="built_in">queue</span>;</span><br><span class="line">    <span class="keyword">auto</span> requestQueueRet = session-&gt;getCaptureRequestMetadataQueue(</span><br><span class="line">        [&amp;<span class="built_in">queue</span>](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; descriptor) &#123;</span><br><span class="line">            <span class="built_in">queue</span> = <span class="built_in">std</span>::make_shared&lt;RequestMetadataQueue&gt;(descriptor);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">queue</span>-&gt;isValid() || <span class="built_in">queue</span>-&gt;availableToWrite() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">"HAL returns empty request metadata fmq, not use it"</span>);</span><br><span class="line">                <span class="built_in">queue</span> = <span class="literal">nullptr</span>;</span><br><span class="line">                <span class="comment">// don't use the queue onwards.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ResultMetadataQueue&gt;&amp; resQueue = mResultMetadataQueue;</span><br><span class="line">    <span class="keyword">auto</span> resultQueueRet = session-&gt;getCaptureResultMetadataQueue(</span><br><span class="line">        [&amp;resQueue](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; descriptor) &#123;</span><br><span class="line">            resQueue = <span class="built_in">std</span>::make_unique&lt;ResultMetadataQueue&gt;(descriptor);</span><br><span class="line">            <span class="keyword">if</span> (!resQueue-&gt;isValid() || resQueue-&gt;availableToWrite() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">"HAL returns empty result metadata fmq, not use it"</span>);</span><br><span class="line">                resQueue = <span class="literal">nullptr</span>;</span><br><span class="line">                <span class="comment">// Don't use the resQueue onwards.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="comment">//上面通过CameraSession获得RequestMetadataQueue和ResultMetadataQueue</span></span><br><span class="line">    mInterface = <span class="keyword">new</span> HalInterface(session, <span class="built_in">queue</span>);<span class="comment">//new一个HalInterface</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> providerType;</span><br><span class="line">    mVendorTagId = manager-&gt;getProviderTagIdLocked(mId.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> initializeCommonLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera3Device::initializeCommonLocked() &#123;</span><br><span class="line">    <span class="comment">//省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Create buffer manager */</span></span><br><span class="line">    mBufferManager = <span class="keyword">new</span> Camera3BufferManager();</span><br><span class="line"></span><br><span class="line">    mTagMonitor.initialize(mVendorTagId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Start up request queue thread */</span></span><br><span class="line">    mRequestThread = <span class="keyword">new</span> RequestThread(<span class="keyword">this</span>, mStatusTracker, mInterface);</span><br><span class="line">    res = mRequestThread-&gt;run(String8::format(<span class="string">"C3Dev-%s-ReqQueue"</span>, mId.<span class="built_in">string</span>()).<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mPreparerThread = <span class="keyword">new</span> PreparerThread();</span><br><span class="line"></span><br><span class="line">    internalUpdateStatusLocked(STATUS_UNCONFIGURED);</span><br><span class="line">    mNextStreamId = <span class="number">0</span>;</span><br><span class="line">    mDummyStreamId = NO_STREAM;</span><br><span class="line">    mNeedConfig = <span class="literal">true</span>;</span><br><span class="line">    mPauseStateNotify = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RequestThread线程用来向Hal提交请求。</p>
<p>我们再回到CameraManager,在CameraService打开Device后，会调用setRemoteDevice方法，将应用层用到的CameraDevice和CameraServer中的CameraDeviceClient绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRemoteDevice</span><span class="params">(ICameraDeviceUser remoteDevice)</span> <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move from decorator to direct binder-mediated exceptions</span></span><br><span class="line">        <span class="comment">// If setRemoteFailure already called, do nothing</span></span><br><span class="line">        <span class="keyword">if</span> (mInError) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//这里又包装了一层</span></span><br><span class="line">        mRemoteDevice = <span class="keyword">new</span> ICameraDeviceUserWrapper(remoteDevice);</span><br><span class="line"></span><br><span class="line">        IBinder remoteDeviceBinder = remoteDevice.asBinder();</span><br><span class="line">        <span class="comment">// For legacy camera device, remoteDevice is in the same process, and</span></span><br><span class="line">        <span class="comment">// asBinder returns NULL.</span></span><br><span class="line">        <span class="keyword">if</span> (remoteDeviceBinder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                remoteDeviceBinder.linkToDeath(<span class="keyword">this</span>, <span class="comment">/*flag*/</span> <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                CameraDeviceImpl.<span class="keyword">this</span>.mDeviceHandler.post(mCallOnDisconnected);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CameraAccessException(CameraAccessException.CAMERA_DISCONNECTED,</span><br><span class="line">                        <span class="string">"The camera device has encountered a serious error"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDeviceHandler.post(mCallOnOpened);</span><br><span class="line">        mDeviceHandler.post(mCallOnUnconfigured);</span><br><span class="line">        <span class="comment">//通过一开始传进来的handler发送消息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable mCallOnOpened = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//省略代码</span></span><br><span class="line">        <span class="comment">//回调一开始传入的StateCallback</span></span><br><span class="line">        mDeviceCallback.onOpened(CameraDeviceImpl.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此，通过CameraManager打开了相机设备，并且应用传入的StateCallback的onOpened被回调。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Camera2 的openCamera同Camera1比较类似，在CameraServer进程中的CameraDevice都是Camera3Device，通过Camera3Device跟Hal层交互。<br>不同之处在Camera1打开相机是同步的，Camera2是异步回调的方式。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/Camera-Service源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/Camera-Service源码分析/" itemprop="url">
                  Camera Service源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-16 18:50:36 / Modified: 18:52:45" itemprop="dateCreated datePublished" datetime="2019-02-16T18:50:36+08:00">2019-02-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Camera-源码分析"><a href="#Camera-源码分析" class="headerlink" title="Camera 源码分析"></a>Camera 源码分析</h2><h3 id="CameraSerivice"><a href="#CameraSerivice" class="headerlink" title="CameraSerivice"></a>CameraSerivice</h3><p>//以下基于Android8.1代码</p>
<p>系统启动后会执行/system/bin/cameraserver</p>
<p>这个程序是由main_cameraServer.cpp生成。</p>
<p>//framworks/av/camera/cameraserver/main_camerserver.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span>** argv __unused)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"> sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line"></span><br><span class="line"> sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line"></span><br><span class="line"> ALOGI(<span class="string">"ServiceManager: %p"</span>, sm.get());</span><br><span class="line"></span><br><span class="line"> CameraService::instantiate();</span><br><span class="line"></span><br><span class="line"> ProcessState::self()-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line"> IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraService::instantiate();<br>这里我们只看这一行，其他的都是和IPC相关的内容。<br>调用了CameraService的静态函数instantiate，而这个静态函数是从它的父类<br>BinderService继承来的。</p>
<p>//framworks/native/include/binder/BinderService.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">instantiate</span><span class="params">()</span> </span>&#123; publish(); &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> status_t <span class="title">publish</span><span class="params">(<span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">     sp&lt;IServiceManager&gt; sm(defaultServiceManager());</span><br><span class="line">      <span class="keyword">return</span> sm-&gt;addService(</span><br><span class="line">              String16(SERVICE::getServiceName()),</span><br><span class="line">              <span class="keyword">new</span> SERVICE(), allowIsolated);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>new了一个CameraService实例并将其addService到ServiceManager。</p>
<p>//framworks/av/services/camera/libcameraservice/CameraService.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CameraService::CameraService() :</span><br><span class="line">        mEventLog(DEFAULT_EVENT_LOG_LENGTH),</span><br><span class="line">        mNumberOfCameras(<span class="number">0</span>), mNumberOfNormalCameras(<span class="number">0</span>),</span><br><span class="line">        mSoundRef(<span class="number">0</span>), mInitialized(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGI(<span class="string">"CameraService started (pid=%d)"</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;camera_device_status_change = android::camera_device_status_change;</span><br><span class="line">    <span class="keyword">this</span>-&gt;torch_mode_status_change = android::torch_mode_status_change;</span><br><span class="line"></span><br><span class="line">    mServiceLockWrapper = <span class="built_in">std</span>::make_shared&lt;WaitableMutexWrapper&gt;(&amp;mServiceLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到CameraService的构造函数只是一些简单的初始化。<br>再看一下CameraService的继承情况。<br>//framworks/av/services/camera/libcameraservice/CameraService.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraService</span> :</span></span><br><span class="line">    <span class="keyword">public</span> BinderService&lt;CameraService&gt;,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ::android::hardware::BnCameraService,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> IBinder::DeathRecipient,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">camera_module_callbacks_t</span>,</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> CameraProviderManager::StatusListener</span><br></pre></td></tr></table></figure>
<p>BinderService提供了Service的创建和发布，BnCameraService是通过ICameraService.aidl<br>生产的类，它继承了BnInterface<icameraservice>,BnInterface<br>又继承了BBinder，BBiner继承了IBinder。所以实际上CameraService<br>是应用进程和camerserver进程IPC通信的服务端实现。</icameraservice></p>
<p>CameraService的初始化其实还没有结束，我们回看ServiceManager的addService函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t            <span class="title">addService</span><span class="params">( <span class="keyword">const</span> String16&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; service,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到第二个参数是sp类型的引用，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt;::sp(T* other)</span><br><span class="line">        : m_ptr(other) &#123;</span><br><span class="line">    <span class="keyword">if</span> (other)</span><br><span class="line">        other-&gt;incStrong(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可能不是调用这个函数但是都是会调用到other-&gt;incStrong(this);</p>
<p>other就是CameraService的指针，incStrong函数继承自RefBase。<br>在incStrong函数里会调用RefBase的onFirstRef函数，这里因为多态的关系，<br>实际上调用到了CameraService的onFirstRef。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CameraService::onFirstRef()</span><br><span class="line">&#123;</span><br><span class="line">   ALOGI(<span class="string">"CameraService process starting"</span>);</span><br><span class="line">    BnCameraService::onFirstRef();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> res = INVALID_OPERATION;</span><br><span class="line"></span><br><span class="line">    res = enumerateProviders();</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        mInitialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CameraService::pingCameraServiceProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>res = enumerateProviders();这一行是关键。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> CameraService::enumerateProviders() &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">l</span><span class="params">(mServiceLock)</span></span>;wanc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化CameraProviderManager</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nullptr</span> == mCameraProviderManager.get()) &#123;</span><br><span class="line">        mCameraProviderManager = <span class="keyword">new</span> CameraProviderManager();</span><br><span class="line">        res = mCameraProviderManager-&gt;initialize(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Unable to initialize camera provider manager: %s (%d)"</span>,</span><br><span class="line">                    __FUNCTION__, strerror(-res), res);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mNumberOfCameras = mCameraProviderManager-&gt;getCameraCount();</span><br><span class="line">    mNumberOfNormalCameras =</span><br><span class="line">            mCameraProviderManager-&gt;getAPI1CompatibleCameraCount();</span><br><span class="line">    <span class="comment">// Setup vendor tags before we call get_camera_info the first time</span></span><br><span class="line">    <span class="comment">// because HAL might need to setup static vendor keys in get_camera_info</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> maybe put this into CameraProviderManager::initialize()?</span></span><br><span class="line">    mCameraProviderManager-&gt;setUpVendorTags();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; cameraId : mCameraProviderManager-&gt;getCameraDeviceIds()) &#123;</span><br><span class="line">        String8 id8 = String8(cameraId.c_str());</span><br><span class="line">        <span class="keyword">bool</span> cameraFound = <span class="literal">false</span>;</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCameraStatesLock)</span></span>;</span><br><span class="line">            <span class="keyword">auto</span> iter = mCameraStates.find(id8);</span><br><span class="line">            <span class="keyword">if</span> (iter != mCameraStates.end()) &#123;</span><br><span class="line">                cameraFound = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cameraFound) &#123;</span><br><span class="line">            hardware::camera::common::V1_0::CameraResourceCost cost;</span><br><span class="line">            res = mCameraProviderManager-&gt;getResourceCost(cameraId, &amp;cost);</span><br><span class="line">            <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">                ALOGE(<span class="string">"Failed to query device resource cost: %s (%d)"</span>, strerror(-res), res);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">set</span>&lt;String8&gt; conflicting;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; cost.conflictingDevices.size(); i++) &#123;</span><br><span class="line">                conflicting.emplace(String8(cost.conflictingDevices[i].c_str()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mCameraStatesLock)</span></span>;</span><br><span class="line">                mCameraStates.emplace(id8,</span><br><span class="line">                    <span class="built_in">std</span>::make_shared&lt;CameraState&gt;(id8, cost.resourceCost, conflicting));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化CameraState，并调用onDeviceStatusChanged</span></span><br><span class="line"></span><br><span class="line">        onDeviceStatusChanged(id8, CameraDeviceStatus::PRESENT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFlashlight-&gt;hasFlashUnit(id8)) &#123;</span><br><span class="line">            mTorchStatusMap.add(id8, TorchModeStatus::AVAILABLE_OFF);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的重点是CameraProviderManager的initialize</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> CameraProviderManager::initialize(wp&lt;CameraProviderManager::StatusListener&gt; listener,</span><br><span class="line">        ServiceInteractionProxy* proxy) &#123;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mInterfaceMutex);</span><br><span class="line">    <span class="keyword">if</span> (proxy == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: No valid service interaction proxy provided"</span>, __FUNCTION__);</span><br><span class="line">        <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    mListener = listener;</span><br><span class="line">    mServiceProxy = proxy;</span><br><span class="line">    <span class="comment">// Registering will trigger notifications for all already-known providers</span></span><br><span class="line">    <span class="keyword">bool</span> success = mServiceProxy-&gt;registerForNotifications(</span><br><span class="line">        <span class="comment">/* instance name, empty means no filter */</span> <span class="string">""</span>,</span><br><span class="line">        <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        ALOGE(<span class="string">"%s: Unable to register with hardware service manager for notifications "</span></span><br><span class="line">                <span class="string">"about camera providers"</span>, __FUNCTION__);</span><br><span class="line">        <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// See if there's a passthrough HAL, but let's not complain if there's not</span></span><br><span class="line">    addProviderLocked(kLegacyProviderName, <span class="comment">/*expected*/</span> <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//const std::string kLegacyProviderName("legacy/0");</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了addProviderLocked函数，字面理解就是添加Provider。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> CameraProviderManager::addProviderLocked(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; newProvider, <span class="keyword">bool</span> expected) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; providerInfo : mProviders) &#123;</span><br><span class="line">        <span class="keyword">if</span> (providerInfo-&gt;mProviderName == newProvider) &#123;</span><br><span class="line">            ALOGW(<span class="string">"%s: Camera provider HAL with name '%s' already registered"</span>, __FUNCTION__,</span><br><span class="line">                    newProvider.c_str());</span><br><span class="line">            <span class="keyword">return</span> ALREADY_EXISTS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//一开始mProvider应该是空的</span></span><br><span class="line"></span><br><span class="line">    sp&lt;provider::V2_4::ICameraProvider&gt; interface;</span><br><span class="line">    interface = mServiceProxy-&gt;getService(newProvider);</span><br><span class="line">    <span class="comment">//virtual sp&lt;hardware::camera::provider::V2_4::ICameraProvider&gt; getService(</span></span><br><span class="line">    <span class="comment">//            const std::string &amp;serviceName) override &#123;</span></span><br><span class="line">    <span class="comment">//        return hardware::camera::provider::V2_4::ICameraProvider::getService(serviceName);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interface == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (expected) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Camera provider HAL '%s' is not actually available"</span>, __FUNCTION__,</span><br><span class="line">                    newProvider.c_str());</span><br><span class="line">            <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;ProviderInfo&gt; providerInfo =</span><br><span class="line">            <span class="keyword">new</span> ProviderInfo(newProvider, interface, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">status_t</span> res = providerInfo-&gt;initialize();</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//new ProviderInfo并初始化，然后添加到vector</span></span><br><span class="line">    mProviders.push_back(providerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下ProviderInfo的initialize函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get initial list of camera devices, if any</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; devices;</span><br><span class="line">    hardware::Return&lt;<span class="keyword">void</span>&gt; ret = mInterface-&gt;getCameraIdList([&amp;status, &amp;devices](</span><br><span class="line">            Status idStatus,</span><br><span class="line">            <span class="keyword">const</span> hardware::hidl_vec&lt;hardware::hidl_string&gt;&amp; cameraDeviceNames) &#123;</span><br><span class="line">        status = idStatus;</span><br><span class="line">        <span class="keyword">if</span> (status == Status::OK) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; cameraDeviceNames.size(); i++) &#123;</span><br><span class="line">                devices.push_back(cameraDeviceNames[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; &#125;);</span><br><span class="line">    <span class="comment">//这里涉及到hidl</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; device : devices) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> id;</span><br><span class="line">        <span class="keyword">status_t</span> res = addDevice(device,</span><br><span class="line">                hardware::camera::common::V1_0::CameraDeviceStatus::PRESENT, &amp;id);</span><br><span class="line">        <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">"%s: Unable to enumerate camera device '%s': %s (%d)"</span>,</span><br><span class="line">                    __FUNCTION__, device.c_str(), strerror(-res), res);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//addDevice会根据从hal拿到的deviceName解析出来的hal版本来创建DeviceInfo或者DeviceInfo3</span></span><br><span class="line">    <span class="comment">//DeviceInfo会持有android.hardware.camera.device@1.0::ICameraDevice类型的引用</span></span><br><span class="line">    <span class="comment">//DeviceInfo3则会持有android.hardware.camera.device@3.2::ICameraDevice类型的引用</span></span><br><span class="line">    <span class="comment">//相当于hal的device在这里的一个代理</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; device : mDevices) &#123;</span><br><span class="line">        mUniqueCameraIds.insert(device-&gt;mId);</span><br><span class="line">        <span class="keyword">if</span> (device-&gt;isAPI1Compatible()) &#123;</span><br><span class="line">            mUniqueAPI1CompatibleCameraIds.insert(device-&gt;mId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mUniqueDeviceCount = mUniqueCameraIds.size();</span><br></pre></td></tr></table></figure>
<p>以上CameraService的初始化才算完成。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>CameraService的初始化比较关键的逻辑是CameraProviderManager的初始化，CameraProviderManager<br>又创建了ProviderInfo，ProviderInfo的初始化会跟hal层交互拿到DeviceInfo，而DeviceInfo又包含了<br>对Hal层设备的引用。这样就建立起了CameraService和Hal层Camera Device的联系。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/26/Camera-preview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/26/Camera-preview/" itemprop="url">
                  Camera-preview
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-26 20:51:54" itemprop="dateCreated datePublished" datetime="2019-01-26T20:51:54+08:00">2019-01-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-01-27 01:57:35" itemprop="dateModified" datetime="2019-01-27T01:57:35+08:00">2019-01-27</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Camera-preview"><a href="#Camera-preview" class="headerlink" title="Camera preview"></a>Camera preview</h2><p>本文主要分析Camera1的preview流程，基于Android8.x。</p>
<h3 id="API调用"><a href="#API调用" class="headerlink" title="API调用"></a>API调用</h3><p>在调用Camera.open打开相机获得Camera对象后，需要设置预览SurfaceHolder。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mCamera.setPreviewDisplay(holder);</span><br><span class="line">mCamera.startPreview();</span><br></pre></td></tr></table></figure></p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>setPreviewDisplay会调用到一个native方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setPreviewSurface</span><span class="params">(Surface surface)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure></p>
<p>jni层对应的cpp文件是frameworks\base\core\jni\android_hardware_Camera.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_hardware_Camera_setPreviewSurface</span><span class="params">(JNIEnv *env, jobject thiz, jobject jSurface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;Camera&gt; camera = get_native_camera(env, thiz, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//这里是从之前openCamera得到的Camera对象，保存在JNICameraContext里面</span></span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line">    sp&lt;Surface&gt; surface;</span><br><span class="line">    <span class="keyword">if</span> (jSurface) &#123;</span><br><span class="line">        surface = android_view_Surface_getSurface(env, jSurface);</span><br><span class="line">        <span class="comment">//将jave层的Surface转换成native层的Surface</span></span><br><span class="line">        <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            gbp = surface-&gt;getIGraphicBufferProducer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera-&gt;setPreviewTarget(gbp) != NO_ERROR) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">"java/io/IOException"</span>, <span class="string">"setPreviewTexture failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于IGraphicBufferProducer<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This class defines the Binder IPC interface for the producer side of</span></span><br><span class="line"><span class="comment"> * a queue of graphics buffers.  It's used to send graphics data from one</span></span><br><span class="line"><span class="comment"> * component to another.  For example, a class that decodes video for</span></span><br><span class="line"><span class="comment"> * playback might use this to provide frames.  This is typically done</span></span><br><span class="line"><span class="comment"> * indirectly, through Surface.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The underlying mechanism is a BufferQueue, which implements</span></span><br><span class="line"><span class="comment"> * BnGraphicBufferProducer.  In normal operation, the producer calls</span></span><br><span class="line"><span class="comment"> * dequeueBuffer() to get an empty buffer, fills it with data, then</span></span><br><span class="line"><span class="comment"> * calls queueBuffer() to make it available to the consumer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This class was previously called ISurfaceTexture.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IGraphicBufferProducer</span> :</span> <span class="keyword">public</span> IInterface</span><br></pre></td></tr></table></figure></p>
<p>我们先看camera的setPreviewTarget，代码路径在frameworks\av\camera\Camera.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pass the buffered IGraphicBufferProducer to the camera service</span></span><br><span class="line"><span class="keyword">status_t</span> Camera::setPreviewTarget(<span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer)</span><br><span class="line">&#123;</span><br><span class="line">    sp &lt;::android::hardware::ICamera&gt; c = mCamera;</span><br><span class="line">    <span class="comment">//mCamera是之前connect CameraServer得到的应该是BpCamera</span></span><br><span class="line">    <span class="keyword">return</span> c-&gt;setPreviewTarget(bufferProducer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们直接看Bn端的实现，因为我们用的API1，所以之前connect在服务端创建的是Camera2Client.<br>代码在\frameworks\av\services\camera\libcameraservice\api1\Camera2Client.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera2Client::setPreviewTarget(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">icl</span><span class="params">(mBinderSerializationLock)</span></span>;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    <span class="keyword">if</span> ( (res = checkPid(__FUNCTION__) ) != OK) <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    sp&lt;IBinder&gt; binder;</span><br><span class="line">    sp&lt;Surface&gt; window;</span><br><span class="line">    <span class="keyword">if</span> (bufferProducer != <span class="number">0</span>) &#123;</span><br><span class="line">        binder = IInterface::asBinder(bufferProducer);</span><br><span class="line">        <span class="comment">// Using controlledByApp flag to ensure that the buffer queue remains in</span></span><br><span class="line">        <span class="comment">// async mode for the old camera API, where many applications depend</span></span><br><span class="line">        <span class="comment">// on that behavior.</span></span><br><span class="line">        window = <span class="keyword">new</span> Surface(bufferProducer, <span class="comment">/*controlledByApp*/</span> <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//使用bufferProducer重新new一个Surface</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setPreviewWindowL(binder, window);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> Camera2Client::setPreviewWindowL(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; binder,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Surface&gt;&amp; window) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line"></span><br><span class="line">    mPreviewSurface = binder;</span><br><span class="line">    res = mStreamingProcessor-&gt;setPreviewWindow(window);</span><br><span class="line">	<span class="comment">//mStreamingProcessor是在Camera2Client初始化是创建的</span></span><br><span class="line">    <span class="keyword">if</span> (state == Parameters::WAITING_FOR_PREVIEW_WINDOW) &#123;</span><br><span class="line">        SharedParameters::<span class="function">Lock <span class="title">l</span><span class="params">(mParameters)</span></span>;</span><br><span class="line">        l.mParameters.state = state;</span><br><span class="line">        <span class="keyword">return</span> startPreviewL(l.mParameters, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>frameworks\av\services\camera\libcameraservice\api1\client2\StreamingProcessor.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> StreamingProcessor::setPreviewWindow(<span class="keyword">const</span> sp&lt;Surface&gt;&amp; window) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">m</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    mPreviewWindow = window;<span class="comment">//保存surface</span></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setPreviewTarget就是将Surface传递到StreamingProcessor，当然是有跨进程在的，并不是直接传递。</p>
<p>接下来，我们看一下startPreivew。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startPreview</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>是一个native方法，对应的jni在frameworks\base\core\jni\android_hardware_Camera.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_hardware_Camera_startPreview</span><span class="params">(JNIEnv *env, jobject thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;Camera&gt; camera = get_native_camera(env, thiz, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//同样是从JNICameraContext拿到Camera对象</span></span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (camera-&gt;startPreview() != NO_ERROR) &#123;</span><br><span class="line">        jniThrowRuntimeException(env, <span class="string">"startPreview failed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// start preview mode</span></span><br><span class="line"><span class="keyword">status_t</span> Camera::startPreview()</span><br><span class="line">&#123;</span><br><span class="line">    ALOGV(<span class="string">"startPreview"</span>);</span><br><span class="line">    sp &lt;::android::hardware::ICamera&gt; c = mCamera;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    <span class="comment">//同样是调用ICamera的Bp端</span></span><br><span class="line">    <span class="keyword">return</span> c-&gt;startPreview();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bn端的实现还是在Camera2Client<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera2Client::startPreview() &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">icl</span><span class="params">(mBinderSerializationLock)</span></span>;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    <span class="keyword">if</span> ( (res = checkPid(__FUNCTION__) ) != OK) <span class="keyword">return</span> res;</span><br><span class="line">    SharedParameters::<span class="function">Lock <span class="title">l</span><span class="params">(mParameters)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> startPreviewL(l.mParameters, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> Camera2Client::startPreviewL(Parameters &amp;params, <span class="keyword">bool</span> restart) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line"></span><br><span class="line">    params.state = Parameters::STOPPED;</span><br><span class="line">    <span class="keyword">int</span> lastPreviewStreamId = mStreamingProcessor-&gt;getPreviewStreamId();</span><br><span class="line"></span><br><span class="line">    res = mStreamingProcessor-&gt;updatePreviewStream(params);</span><br><span class="line">	<span class="comment">//StreamingProcessor的updatePreviewStream会调用Device的createStream函数</span></span><br><span class="line">	<span class="comment">//createStream函数中会创建Camera3OutputStream</span></span><br><span class="line">    <span class="keyword">bool</span> previewStreamChanged = mStreamingProcessor-&gt;getPreviewStreamId() != lastPreviewStreamId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callbacksEnabled) &#123;</span><br><span class="line"></span><br><span class="line">        res = mCallbackProcessor-&gt;updateStream(params);</span><br><span class="line"></span><br><span class="line">        outputStreams.push(getCallbackStreamId());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (previewStreamChanged &amp;&amp; mCallbackProcessor-&gt;getStreamId() != NO_STREAM) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    outputStreams.push(getPreviewStreamId());</span><br><span class="line"><span class="keyword">if</span> (!params.recordingHint) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!restart) &#123;</span><br><span class="line">            res = mStreamingProcessor-&gt;updatePreviewRequest(params);</span><br><span class="line">            <span class="comment">//updatePreviewRequest会调用device的createDefaultRequest</span></span><br><span class="line">        &#125;</span><br><span class="line">        res = mStreamingProcessor-&gt;startStream(StreamingProcessor::PREVIEW,</span><br><span class="line">                outputStreams);</span><br><span class="line">                <span class="comment">//这个会调用device的setStreamingRequest，将上面创建的request通过device提交给hal</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!restart) &#123;</span><br><span class="line">            res = mStreamingProcessor-&gt;updateRecordingRequest(params);</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">        res = mStreamingProcessor-&gt;startStream(StreamingProcessor::RECORD,</span><br><span class="line">                outputStreams);</span><br><span class="line">    &#125;</span><br><span class="line">、</span><br><span class="line"></span><br><span class="line">    params.state = Parameters::PREVIEW;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们跳过跟hal层的复杂的交互，看看Callback是怎么回调的。</p>
<p>直接看看CallbackProcessor::processNewCallback，经过一系列的判断会将数据放在buffer，然后调用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l.mRemoteCallback-&gt;dataCallback(CAMERA_MSG_PREVIEW_FRAME,</span><br><span class="line">                    callbackHeap-&gt;mBuffers[heapIdx], <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure></p>
<p>实际上这里会调用ICameraClient的接口dataCallback，这里调用的是Bp端，而Bn端就是一开始setupCamera的时候创建的Camera</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callback from camera service when frame or image is ready</span></span><br><span class="line"><span class="keyword">void</span> Camera::dataCallback(<span class="keyword">int32_t</span> msgType, <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr,</span><br><span class="line">                          <span class="keyword">camera_frame_metadata_t</span> *metadata)</span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;CameraListener&gt; listener;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        listener = mListener;</span><br><span class="line">        <span class="comment">//mListenr也是一开始setup的是设置的，就是JNICameraContext</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        listener-&gt;postData(msgType, dataPtr, metadata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> JNICameraContext::postData(<span class="keyword">int32_t</span> msgType, <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr,</span><br><span class="line">                                <span class="keyword">camera_frame_metadata_t</span> *metadata)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> dataMsgType = msgType &amp; ~CAMERA_MSG_PREVIEW_METADATA;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return data based on callback type</span></span><br><span class="line">    <span class="keyword">switch</span> (dataMsgType) &#123;</span><br><span class="line">        <span class="keyword">case</span> CAMERA_MSG_VIDEO_FRAME:</span><br><span class="line">            <span class="comment">// should never happen</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For backward-compatibility purpose, if there is no callback</span></span><br><span class="line">        <span class="comment">// buffer for raw image, the callback returns null.</span></span><br><span class="line">        <span class="keyword">case</span> CAMERA_MSG_RAW_IMAGE:</span><br><span class="line">            ALOGV(<span class="string">"rawCallback"</span>);</span><br><span class="line">            <span class="keyword">if</span> (mRawImageCallbackBuffers.isEmpty()) &#123;</span><br><span class="line">                env-&gt;CallStaticVoidMethod(mCameraJClass, fields.post_event,</span><br><span class="line">                        mCameraJObjectWeak, dataMsgType, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                copyAndPost(env, dataPtr, dataMsgType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// There is no data.</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">//CAMERA_MSG_PREVIEW_FRAME</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ALOGV(<span class="string">"dataCallback(%d, %p)"</span>, dataMsgType, dataPtr.get());</span><br><span class="line">            copyAndPost(env, dataPtr, dataMsgType);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post frame metadata to Java//metadata 是NULL</span></span><br><span class="line">    <span class="keyword">if</span> (metadata &amp;&amp; (msgType &amp; CAMERA_MSG_PREVIEW_METADATA)) &#123;</span><br><span class="line">        postMetadata(env, CAMERA_MSG_PREVIEW_METADATA, metadata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> JNICameraContext::copyAndPost(JNIEnv* env, <span class="keyword">const</span> sp&lt;IMemory&gt;&amp; dataPtr, <span class="keyword">int</span> msgType)</span><br><span class="line">&#123;</span><br><span class="line">    jbyteArray obj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate Java byte array and copy data</span></span><br><span class="line">    <span class="keyword">if</span> (dataPtr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">ssize_t</span> offset;</span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        sp&lt;IMemoryHeap&gt; heap = dataPtr-&gt;getMemory(&amp;offset, &amp;size);</span><br><span class="line">        ALOGV(<span class="string">"copyAndPost: off=%zd, size=%zu"</span>, offset, size);</span><br><span class="line">        <span class="keyword">uint8_t</span> *heapBase = (<span class="keyword">uint8_t</span>*)heap-&gt;base();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (heapBase != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> jbyte* data = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> jbyte*&gt;(heapBase + offset);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (msgType == CAMERA_MSG_RAW_IMAGE) &#123;</span><br><span class="line">                obj = getCallbackBuffer(env, &amp;mRawImageCallbackBuffers, size);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msgType == CAMERA_MSG_PREVIEW_FRAME &amp;&amp; mManualBufferMode) &#123;</span><br><span class="line">                obj = getCallbackBuffer(env, &amp;mCallbackBuffers, size);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mCallbackBuffers.isEmpty()) &#123;</span><br><span class="line">                    ALOGV(<span class="string">"Out of buffers, clearing callback!"</span>);</span><br><span class="line">                    mCamera-&gt;setPreviewCallbackFlags(CAMERA_FRAME_CALLBACK_FLAG_NOOP);</span><br><span class="line">                    mManualCameraCallbackSet = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGV(<span class="string">"Allocating callback buffer"</span>);</span><br><span class="line">                obj = env-&gt;NewByteArray(size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ALOGE(<span class="string">"Couldn't allocate byte array for JPEG data"</span>);</span><br><span class="line">                env-&gt;ExceptionClear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                env-&gt;SetByteArrayRegion(obj, <span class="number">0</span>, size, data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"image heap is NULL"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post image data to Java</span></span><br><span class="line">    env-&gt;CallStaticVoidMethod(mCameraJClass, fields.post_event,</span><br><span class="line">            mCameraJObjectWeak, msgType, <span class="number">0</span>, <span class="number">0</span>, obj);</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        env-&gt;DeleteLocalRef(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fields.post_event = GetStaticMethodIDOrDie(env, clazz, <span class="string">"postEventFromNative"</span>,</span><br><span class="line">                                               <span class="string">"(Ljava/lang/Object;IIILjava/lang/Object;)V"</span>);</span><br></pre></td></tr></table></figure>
<p>上面的操作就是将数据从IMemory中取出转成javaByte数组，在调用Java层的postEventFromNative方法将数据和msgType传递到java层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">postEventFromNative</span><span class="params">(Object camera_ref,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">int</span> what, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, Object obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Camera c = (Camera)((WeakReference)camera_ref).get();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c.mEventHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Message m = c.mEventHandler.obtainMessage(what, arg1, arg2, obj);</span><br><span class="line">        c.mEventHandler.sendMessage(m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>java层通过EventHandler发送消息，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">case</span> CAMERA_MSG_PREVIEW_FRAME:</span><br><span class="line">                PreviewCallback pCb = mPreviewCallback;</span><br><span class="line">                <span class="keyword">if</span> (pCb != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mOneShot) &#123;</span><br><span class="line">                        <span class="comment">// Clear the callback variable before the callback</span></span><br><span class="line">                        <span class="comment">// in case the app calls setPreviewCallback from</span></span><br><span class="line">                        <span class="comment">// the callback function</span></span><br><span class="line">                        mPreviewCallback = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mWithBuffer) &#123;</span><br><span class="line">                        <span class="comment">// We're faking the camera preview mode to prevent</span></span><br><span class="line">                        <span class="comment">// the app from being flooded with preview frames.</span></span><br><span class="line">                        <span class="comment">// Set to oneshot mode again.</span></span><br><span class="line">                        setHasPreviewCallback(<span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//这里就看到我们的onPreviewFrame回调被调用了</span></span><br><span class="line">                    pCb.onPreviewFrame((<span class="keyword">byte</span>[])msg.obj, mCamera);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Camera1的preview主要有三点，一是设置Surface，用来显示预览画面，二是startPreview，这个过程会通过CameraServer到Hal层，创建请求，提交请求，主要逻辑在StreamProcessor中。最后是预览数据的回调，CallbackProcessor处理回调数据通过ICameraClient将数据传递到应用进程，最终回调到上层。总的来讲，Device的createStream，createDefaultRequest，setStreamingRequest，涉及到跟HAL层的交互，比较复杂，但是应用进程和CameraServer的交互还是比较清晰的。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/Camera-open/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/Camera-open/" itemprop="url">
                  Camera open
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-13 21:47:55 / Modified: 21:48:50" itemprop="dateCreated datePublished" datetime="2019-01-13T21:47:55+08:00">2019-01-13</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Camera-open流程分析"><a href="#Camera-open流程分析" class="headerlink" title="Camera open流程分析"></a>Camera open流程分析</h2><p>本文主要分析Camera通过应用层调用open的流程。假设使用Camera1的API。基于android8。</p>
<h3 id="Jni调用"><a href="#Jni调用" class="headerlink" title="Jni调用"></a>Jni调用</h3><p>在应用层调用Camera的open方法会调用到jni层android_hardware_Camera_native_setup函数。<br>代码路径在framworks/base/core/jni/android_hardware_Camera.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Camera&gt; camera;</span><br><span class="line">   <span class="keyword">if</span> (halVersion == CAMERA_HAL_API_VERSION_NORMAL_CONNECT) &#123;</span><br><span class="line">       <span class="comment">// Default path: hal version is don't care, do normal camera connect.</span></span><br><span class="line">       <span class="comment">//正常连接camera设备，调用Camera类的静态函数connect</span></span><br><span class="line">       <span class="comment">//传入要连接的id，0代表后置摄像头，1代表前置，clientName是调用者的包名</span></span><br><span class="line">       camera = Camera::connect(cameraId, clientName,</span><br><span class="line">               Camera::USE_CALLING_UID, Camera::USE_CALLING_PID);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       jint status = Camera::connectLegacy(cameraId, halVersion, clientName,</span><br><span class="line">               Camera::USE_CALLING_UID, camera);</span><br><span class="line">       <span class="keyword">if</span> (status != NO_ERROR) &#123;</span><br><span class="line">           <span class="keyword">return</span> status;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="native层跟踪"><a href="#native层跟踪" class="headerlink" title="native层跟踪"></a>native层跟踪</h3><p>connect函数的声明， 代码路径在frameworks/av/camera/include/camera/Camera.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span>  sp&lt;Camera&gt;  connect(<span class="keyword">int</span> cameraId,</span><br><span class="line">                               <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">                               <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid);</span><br></pre></td></tr></table></figure>
<p>其实现在frameworks/av/camera/Camera.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Camera&gt; Camera::connect(<span class="keyword">int</span> cameraId, <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//调用CameraBaseT的静态函数connect</span></span><br><span class="line">    <span class="keyword">return</span> CameraBaseT::connect(cameraId, clientPackageName, clientUid, clientPid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>CameraBase是Camere的父类，同时他也是一个模板类。他的connect函数实现在<br>frameworks/av/camera/CameraBase.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TCam就是Camera</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TCam, <span class="keyword">typename</span> TCamTraits&gt;</span><br><span class="line">sp&lt;TCam&gt; CameraBase&lt;TCam, TCamTraits&gt;::connect(<span class="keyword">int</span> cameraId,</span><br><span class="line">                                               <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">                                               <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//new Camera</span></span><br><span class="line">    sp&lt;TCam&gt; c = <span class="keyword">new</span> TCam(cameraId);</span><br><span class="line">    sp&lt;TCamCallbacks&gt; cl = c;</span><br><span class="line">    <span class="keyword">const</span> sp&lt;::android::hardware::ICameraService&gt; cs = getCameraService();</span><br><span class="line"></span><br><span class="line">    binder::Status ret;</span><br><span class="line">    <span class="keyword">if</span> (cs != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        TCamConnectService fnConnectService = TCamTraits::fnConnectService;</span><br><span class="line">        ret = (cs.get()-&gt;*fnConnectService)(cl, cameraId, clientPackageName, clientUid,</span><br><span class="line">                                               clientPid, <span class="comment">/*out*/</span> &amp;c-&gt;mCamera);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//c-&gt;mCamera实际上是CameraBase的成员sp&lt;TCamUser&gt; mCamera;</span></span><br><span class="line">    <span class="comment">//TCamUser就是::android::hardware::ICamera</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到先new一个Camera然后拿到CameraService的代理，调用CameraService的一个函数，是通过函数指针的方式调用的。</p>
<p>CameraTraits的定义</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CameraTraits</span>&lt;Camera&gt;</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> CameraListener                     TCamListener;</span><br><span class="line">    <span class="keyword">typedef</span> ::android::hardware::ICamera       TCamUser;</span><br><span class="line">    <span class="keyword">typedef</span> ::android::hardware::ICameraClient TCamCallbacks;</span><br><span class="line">    <span class="keyword">typedef</span> ::android::binder::Status(::android::hardware::ICameraService::*TCamConnectService)</span><br><span class="line">        (<span class="keyword">const</span> sp&lt;::android::hardware::ICameraClient&gt;&amp;,</span><br><span class="line">        <span class="keyword">int</span>, <span class="keyword">const</span> String16&amp;, <span class="keyword">int</span>, <span class="keyword">int</span>,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        sp&lt;::android::hardware::ICamera&gt;*);</span><br><span class="line">    <span class="keyword">static</span> TCamConnectService     fnConnectService;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>::android::hardware::ICameraClient和::android::hardware::ICamera代表了两个binder通信，<br>ICameraClient的服务端其实是调用者进程也就是应用进程，客户端就是BnCameraService的进程。<br>ICamera的客户端是应用进程，服务端是BnCameraService所在进程。<br>fnConnectService函数指针的定义在Camera.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CameraTraits&lt;Camera&gt;::TCamConnectService CameraTraits&lt;Camera&gt;::fnConnectService =</span><br><span class="line">        &amp;::android::hardware::ICameraService::connect;</span><br></pre></td></tr></table></figure>
<p>实际上就是ICameraService的connect函数，可以理解为调用了BpCameraService的connect函数。</p>
<p>通过binder进行ipc通信后会调用到CameraSerivce::connect函数，CameraService继承了BnCameraService。代码路径在frameworks/av/services/camera/libcameraservice/CameraService.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Status CameraService::connect(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ICameraClient&gt;&amp; cameraClient,</span><br><span class="line">        <span class="keyword">int</span> cameraId,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">int</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        sp&lt;ICamera&gt;* device) &#123;</span><br><span class="line"></span><br><span class="line">    Status ret = Status::ok();</span><br><span class="line">    String8 id = String8::format(<span class="string">"%d"</span>, cameraId);</span><br><span class="line">    sp&lt;Client&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">//调用传递到connectHelper</span></span><br><span class="line">    ret = connectHelper&lt;ICameraClient,Client&gt;(cameraClient, id,</span><br><span class="line">            CAMERA_HAL_API_VERSION_UNSPECIFIED, clientPackageName, clientUid, clientPid, API_1,</span><br><span class="line">            <span class="comment">/*legacyMode*/</span> <span class="literal">false</span>, <span class="comment">/*shimUpdateOnly*/</span> <span class="literal">false</span>,</span><br><span class="line">            <span class="comment">/*out*/</span>client);</span><br><span class="line"></span><br><span class="line">    *device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">CALLBACK</span>, <span class="title">class</span> <span class="title">CLIENT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">Status</span> <span class="title">CameraService</span>:</span>:connectHelper(<span class="keyword">const</span> sp&lt;CALLBACK&gt;&amp; cameraCb, <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> halVersion, <span class="keyword">const</span> String16&amp; clientPackageName, <span class="keyword">int</span> clientUid, <span class="keyword">int</span> clientPid,</span><br><span class="line">        apiLevel effectiveApiLevel, <span class="keyword">bool</span> legacyMode, <span class="keyword">bool</span> shimUpdateOnly,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;CLIENT&gt;&amp; device) &#123;</span><br><span class="line">    binder::Status ret = binder::Status::ok();</span><br><span class="line"></span><br><span class="line">    <span class="function">String8 <span class="title">clientName8</span><span class="params">(clientPackageName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> originalClientPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sp&lt;CLIENT&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Acquire mServiceLock and prevent other clients from connecting</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;AutoConditionLock&gt; lock =</span><br><span class="line">                AutoConditionLock::waitAndAcquire(mServiceLockWrapper, DEFAULT_CONNECT_TIMEOUT_NS);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//验证权限</span></span><br><span class="line">        <span class="comment">// Enforce client permissions and do basic sanity checks</span></span><br><span class="line">        <span class="keyword">if</span>(!(ret = validateConnectLocked(cameraId, clientName8,</span><br><span class="line">                <span class="comment">/*inout*/</span>clientUid, <span class="comment">/*inout*/</span>clientPid, <span class="comment">/*out*/</span>originalClientPid)).isOk()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">status_t</span> err;</span><br><span class="line"></span><br><span class="line">        sp&lt;BasicClient&gt; clientTmp = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;resource_policy::ClientDescriptor&lt;String8, sp&lt;BasicClient&gt;&gt;&gt; partial;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// give flashlight a chance to close devices if necessary.</span></span><br><span class="line">        mFlashlight-&gt;prepareDeviceOpen(cameraId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> facing = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">int</span> deviceVersion = getDeviceVersion(cameraId, <span class="comment">/*out*/</span>&amp;facing);</span><br><span class="line"></span><br><span class="line">        sp&lt;BasicClient&gt; tmp = <span class="literal">nullptr</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//makeClient函数会创建client</span></span><br><span class="line">        <span class="keyword">if</span>(!(ret = makeClient(<span class="keyword">this</span>, cameraCb, clientPackageName, cameraId, facing, clientPid,</span><br><span class="line">                clientUid, getpid(), legacyMode, halVersion, deviceVersion, effectiveApiLevel,</span><br><span class="line">                <span class="comment">/*out*/</span>&amp;tmp)).isOk()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        client = <span class="keyword">static_cast</span>&lt;CLIENT*&gt;(tmp.get());</span><br><span class="line"></span><br><span class="line">		<span class="comment">//调用client的initialize函数</span></span><br><span class="line">        err = client-&gt;initialize(mCameraProviderManager);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shimUpdateOnly) &#123;</span><br><span class="line">            <span class="comment">// If only updating legacy shim parameters, immediately disconnect client</span></span><br><span class="line">            mServiceLock.unlock();</span><br><span class="line">            client-&gt;disconnect();</span><br><span class="line">            mServiceLock.lock();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Otherwise, add client to active clients list</span></span><br><span class="line">            finishConnectLocked(client, partial);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// lock is destroyed, allow further connect calls</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Important: release the mutex here so the client can call back into the service from its</span></span><br><span class="line">    <span class="comment">// destructor (can be at the end of the call)</span></span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据不同的hal版本会走不同的路径，这里我们考虑hal版本为3.x</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">*client = <span class="keyword">new</span> Camera2Client(cameraService, tmp, packageName, cameraIdToInt(cameraId),</span><br><span class="line">                       facing, clientPid, clientUid, servicePid, legacyMode);</span><br></pre></td></tr></table></figure>
<p>new 了一个Camera2Client对象。Camera2Client代码路径frameworks/av/servicves/camera/libcameraservice/api1/Camera2Client.h.他的继承情况</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Camera2Client</span> :</span></span><br><span class="line">        <span class="keyword">public</span> Camera2ClientBase&lt;CameraService::Client&gt;</span><br></pre></td></tr></table></figure>
<p>所以会依次调用Camera2ClientBase的构造函数和Clinet的构造函数，<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> :</span> <span class="keyword">public</span> hardware::BnCamera, <span class="keyword">public</span> BasicClient</span><br></pre></td></tr></table></figure></p>
<p>继续向上会调用到BasicClient的构造函数。</p>
<p>在Camera2ClientBase构造函数中会创建Camera3Device对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br></pre></td></tr></table></figure>
<p>回到CameraService::connectHelper，在makeClient之后要调用Client的initialize函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2Client::initializeImpl(TProviderPtr providerPtr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">	<span class="comment">//调用父类的initialize</span></span><br><span class="line">    res = Camera2ClientBase::initialize(providerPtr);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        SharedParameters::<span class="function">Lock <span class="title">l</span><span class="params">(mParameters)</span></span>;</span><br><span class="line"></span><br><span class="line">        res = l.mParameters.initialize(&amp;(mDevice-&gt;info()), mDeviceVersion);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initializeImpl(TProviderPtr providerPtr) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify ops permissions</span></span><br><span class="line">    res = TClientBase::startCameraOps();</span><br><span class="line"></span><br><span class="line">    res = mDevice-&gt;initialize(providerPtr);</span><br><span class="line"></span><br><span class="line">    wp&lt;CameraDeviceBase::NotificationListener&gt; weakThis(<span class="keyword">this</span>);</span><br><span class="line">    res = mDevice-&gt;setNotifyCallback(weakThis);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有两个点，一是调用了TClientBase的startCameraOps函数，二是mDevice调用了initialize函数。TClientBase就是CameraService::Client,startCameraOps继承CameraService::BasicClient.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">status_t</span> CameraService::BasicClient::startCameraOps() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> res;</span><br><span class="line">    <span class="comment">// Notify app ops that the camera is not available</span></span><br><span class="line">    mOpsCallback = <span class="keyword">new</span> OpsCallback(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    mAppOpsManager.startWatchingMode(AppOpsManager::OP_CAMERA,</span><br><span class="line">            mClientPackageName, mOpsCallback);</span><br><span class="line">    res = mAppOpsManager.startOp(AppOpsManager::OP_CAMERA,</span><br><span class="line">            mClientUid, mClientPackageName);</span><br><span class="line"></span><br><span class="line">    mOpsActive = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transition device availability listeners from PRESENT -&gt; NOT_AVAILABLE</span></span><br><span class="line">    sCameraService-&gt;updateStatus(StatusInternal::NOT_AVAILABLE, mCameraIdStr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transition device state to OPEN</span></span><br><span class="line">    sCameraService-&gt;updateProxyDeviceState(ICameraServiceProxy::CAMERA_STATE_OPEN,</span><br><span class="line">            mCameraIdStr, mCameraFacing, mClientPackageName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的关键是调用了mAppOpsManager的startOp函数，实际上会调用到IAppOpsService的Bp代理的startOperation函数，通过Binder会在BnAppOpsService端实现。然后调用CamraService调用更新状态的函数。<br>frameworks/base/core/java/com/android/internal/app/IAppOpsService.aidl<br>frameworks/native/libs/binder/include/binder/IAppOpsService.h<br>frameworks/native/libs/binder/IAppOpsService.cpp<br>在BnAppOpsService的onTransact函数中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> START_OPERATION_TRANSACTION: &#123;</span><br><span class="line">            CHECK_INTERFACE(IAppOpsService, data, reply);</span><br><span class="line">            sp&lt;IBinder&gt; token = data.readStrongBinder();</span><br><span class="line">            <span class="keyword">int32_t</span> code = data.readInt32();</span><br><span class="line">            <span class="keyword">int32_t</span> uid = data.readInt32();</span><br><span class="line">            String16 packageName = data.readString16();</span><br><span class="line">            <span class="keyword">int32_t</span> res = startOperation(token, code, uid, packageName);</span><br><span class="line">            reply-&gt;writeNoException();</span><br><span class="line">            reply-&gt;writeInt32(res);</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>那么真正实现startOperation的地方在哪里呢？<br>我们暂时不管，回到Camera2ClientBase的initialize函数，调用Camera3Device的initialize函数。<br>这个函数会跟hal层交互，暂时不再继续。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Camrea的open流程主要就是通过CameraService的connect函数与Hal层的Camera3Device建立联系。CameraService对CameraDevice的操作会委托CameraProviderManager，进而通过ProviderInfo获取DeviceInfo，再通过DeviceInfo和Hal进行交互。或者Camera对象持有ICamera的Bp代理，可以通过它来进行调用Camera2Client，进而通过Camera2Client的Camera3Device和Hal层交互。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/hello-world/" itemprop="url">
                  Hello World
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-01-13 21:47:14" itemprop="dateCreated datePublished" datetime="2019-01-13T21:47:14+08:00">2019-01-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-09-13 21:51:32" itemprop="dateModified" datetime="2018-09-13T21:51:32+08:00">2018-09-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/22/Animator源码阅读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/22/Animator源码阅读/" itemprop="url">
                  Animator源码阅读
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-22 21:06:44 / Modified: 21:19:18" itemprop="dateCreated datePublished" datetime="2018-10-22T21:06:44+08:00">2018-10-22</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Animator"><a href="#Animator" class="headerlink" title="Animator"></a>Animator</h1><p>本文主要分析Animator的源码.</p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ValueAnimator anim = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">anim.setDuration(<span class="number">300</span>);</span><br><span class="line">anim.start();</span><br></pre></td></tr></table></figure>
<h2 id="源码追溯"><a href="#源码追溯" class="headerlink" title="源码追溯"></a>源码追溯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ValueAnimator <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    ValueAnimator anim = <span class="keyword">new</span> ValueAnimator();</span><br><span class="line">    anim.setFloatValues(values);</span><br><span class="line">    <span class="keyword">return</span> anim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先看ValueAnimator的静态方法ofFloat，首先new一个ValueAnimator对象，再调用它的setFloatValues方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFloatValues</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (values == <span class="keyword">null</span> || values.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mValues == <span class="keyword">null</span> || mValues.length == <span class="number">0</span>) &#123;</span><br><span class="line">        setValues(PropertyValuesHolder.ofFloat(<span class="string">""</span>, values));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PropertyValuesHolder valuesHolder = mValues[<span class="number">0</span>];</span><br><span class="line">        valuesHolder.setFloatValues(values);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// New property/values/target should cause re-initialization prior to starting</span></span><br><span class="line">    mInitialized = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PropertyValuesHolder[] mValues;</span><br></pre></td></tr></table></figure>
<p>将values传递到PropertyValuesHolder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFloatValues</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    mValueType = <span class="keyword">float</span>.class;</span><br><span class="line">    mKeyframes = KeyframeSet.ofFloat(values);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>赋值PropertyValuesHolder的成员mValueType，并将values传递到KeyframeSet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KeyframeSet <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> badValue = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> numKeyframes = values.length;</span><br><span class="line">    FloatKeyframe keyframes[] = <span class="keyword">new</span> FloatKeyframe[Math.max(numKeyframes,<span class="number">2</span>)];</span><br><span class="line">    <span class="keyword">if</span> (numKeyframes == <span class="number">1</span>) &#123;</span><br><span class="line">        keyframes[<span class="number">0</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">0f</span>);</span><br><span class="line">        keyframes[<span class="number">1</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">1f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (Float.isNaN(values[<span class="number">0</span>])) &#123;</span><br><span class="line">            badValue = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyframes[<span class="number">0</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">0f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numKeyframes; ++i) &#123;</span><br><span class="line">            keyframes[i] =</span><br><span class="line">                    (FloatKeyframe) Keyframe.ofFloat((<span class="keyword">float</span>) i / (numKeyframes - <span class="number">1</span>), values[i]);</span><br><span class="line">            <span class="keyword">if</span> (Float.isNaN(values[i])) &#123;</span><br><span class="line">                badValue = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (badValue) &#123;</span><br><span class="line">        Log.w(<span class="string">"Animator"</span>, <span class="string">"Bad value (NaN) in float animator"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FloatKeyframeSet(keyframes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Keyframe <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FloatKeyframe(fraction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Keyframe <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span> fraction, <span class="keyword">float</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FloatKeyframe(fraction, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到最终返回一个FloatKeyframeSet，包含的每一个元素类型是FloatKeyframe，<br>每一个FloatKeyframe又包含了此关键帧的在整个动画过程中的位置（以百分数的形式），和它此时的value。</p>
<p>接下来setDuration不用说了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    start(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> playBackwards)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Looper.myLooper() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"Animators may only be run on Looper threads"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mReversing = playBackwards;</span><br><span class="line">    mSelfPulse = !mSuppressSelfPulseRequested;</span><br><span class="line">    <span class="comment">// Special case: reversing from seek-to-0 should act as if not seeked at all.</span></span><br><span class="line">    <span class="keyword">if</span> (playBackwards &amp;&amp; mSeekFraction != -<span class="number">1</span> &amp;&amp; mSeekFraction != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRepeatCount == INFINITE) &#123;</span><br><span class="line">            <span class="comment">// Calculate the fraction of the current iteration.</span></span><br><span class="line">            <span class="keyword">float</span> fraction = (<span class="keyword">float</span>) (mSeekFraction - Math.floor(mSeekFraction));</span><br><span class="line">            mSeekFraction = <span class="number">1</span> - fraction;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSeekFraction = <span class="number">1</span> + mRepeatCount - mSeekFraction;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mStarted = <span class="keyword">true</span>;</span><br><span class="line">    mPaused = <span class="keyword">false</span>;</span><br><span class="line">    mRunning = <span class="keyword">false</span>;</span><br><span class="line">    mAnimationEndRequested = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// Resets mLastFrameTime when start() is called, so that if the animation was running,</span></span><br><span class="line">    <span class="comment">// calling start() would put the animation in the</span></span><br><span class="line">    <span class="comment">// started-but-not-yet-reached-the-first-frame phase.</span></span><br><span class="line">    mLastFrameTime = -<span class="number">1</span>;</span><br><span class="line">    mFirstFrameTime = -<span class="number">1</span>;</span><br><span class="line">    mStartTime = -<span class="number">1</span>;</span><br><span class="line">    addAnimationCallback(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStartDelay == <span class="number">0</span> || mSeekFraction &gt;= <span class="number">0</span> || mReversing) &#123;</span><br><span class="line">        <span class="comment">// If there's no start delay, init the animation and notify start listeners right away</span></span><br><span class="line">        <span class="comment">// to be consistent with the previous behavior. Otherwise, postpone this until the first</span></span><br><span class="line">        <span class="comment">// frame after the start delay.</span></span><br><span class="line">        startAnimation();</span><br><span class="line">        <span class="keyword">if</span> (mSeekFraction == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// No seek, start at play time 0. Note that the reason we are not using fraction 0</span></span><br><span class="line">            <span class="comment">// is because for animations with 0 duration, we want to be consistent with pre-N</span></span><br><span class="line">            <span class="comment">// behavior: skip to the final value immediately.</span></span><br><span class="line">            setCurrentPlayTime(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setCurrentFraction(mSeekFraction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先设置一些状态，然后调用了addAnimationCallback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAnimationCallback</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSelfPulse) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    getAnimationHandler().addAnimationFrameCallback(<span class="keyword">this</span>, delay);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> AnimationHandler <span class="title">getAnimationHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AnimationHandler.getInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AnimationHandler是跟Looper类似的与线程绑定，同一个线程中get到的是同一个实例，这是通过<br>ThreadLocal实现的（ThreadLocalMap是以ThreadLocal为key，AnimationHandler的map）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAnimationFrameCallback</span><span class="params">(<span class="keyword">final</span> AnimationFrameCallback callback, <span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAnimationCallbacks.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        getProvider().postFrameCallback(mFrameCallback);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mAnimationCallbacks.contains(callback)) &#123;</span><br><span class="line">        mAnimationCallbacks.add(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mDelayedCallbackStartTime.put(callback, (SystemClock.uptimeMillis() + delay));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ValueAnimator实现了AnimationFrameCallback接口，AnimationHandler的成员mAnimationCallbacks添加这个AnimationFrameCallback实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AnimationFrameCallbackProvider <span class="title">getProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mProvider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProvider = <span class="keyword">new</span> MyFrameCallbackProvider();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mProvider;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MyFrameCallbackProvider.java</span></span><br><span class="line"><span class="keyword">final</span> Choreographer mChoreographer = Choreographer.getInstance();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postFrameCallback</span><span class="params">(Choreographer.FrameCallback callback)</span> </span>&#123;               mChoreographer.postFrameCallback(callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里的callback</span></span><br><span class="line"><span class="comment">//AnimationHandler.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Choreographer.FrameCallback mFrameCallback = <span class="keyword">new</span> Choreographer.FrameCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        doAnimationFrame(getProvider().getFrameTime());</span><br><span class="line">        <span class="keyword">if</span> (mAnimationCallbacks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            getProvider().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Choreographer实例同样是保存在ThreadLocal中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Choreographer.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postFrameCallback</span><span class="params">(FrameCallback callback)</span> </span>&#123;</span><br><span class="line">    postFrameCallbackDelayed(callback, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postFrameCallbackDelayed</span><span class="params">(FrameCallback callback, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callback must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    postCallbackDelayedInternal(CALLBACK_ANIMATION,</span><br><span class="line">            callback, FRAME_CALLBACK_TOKEN, delayMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,//== <span class="number">1</span></span></span></span><br><span class="line"><span class="function"><span class="params">        Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">            scheduleFrameLocked(now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">            msg.arg1 = callbackType;</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CallbackQueue[] mCallbackQueues;</span><br><span class="line"></span><br><span class="line"><span class="comment">//FrameHandler</span></span><br><span class="line"><span class="keyword">case</span> MSG_DO_SCHEDULE_CALLBACK:</span><br><span class="line">                doScheduleCallback(msg.arg1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>将callback加入队列，如果没有延迟直接调用scheduleFrameLocked，如果有延迟通过FrameHandler定时发送消息触发doScheduleCallback，它最后还是调用scheduleFrameLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Enable/disable vsync for animations and drawing.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> USE_VSYNC = SystemProperties.getBoolean(</span><br><span class="line">        <span class="string">"debug.choreographer.vsync"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFrameLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">        mFrameScheduled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (USE_VSYNC) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If running on the Looper thread, then schedule the vsync immediately,</span></span><br><span class="line">            <span class="comment">// otherwise post a message to schedule the vsync from the UI thread</span></span><br><span class="line">            <span class="comment">// as soon as possible.</span></span><br><span class="line">            <span class="keyword">if</span> (isRunningOnLooperThreadLocked()) &#123;</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtFrontOfQueue(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nextFrameTime = Math.max(</span><br><span class="line">                    mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);</span><br><span class="line">            Message msg = mHandler.obtainMessage(MSG_DO_FRAME);</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, nextFrameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果使用垂直同步，在Choreographer所在的Looper上执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDisplayEventReceiver.scheduleVsync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DisplayEventReceiver.java</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Schedules a single vertical sync pulse to be delivered when the next</span></span><br><span class="line"><span class="comment"> * display frame begins.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Attempted to schedule a vertical sync pulse but the display event "</span></span><br><span class="line">                + <span class="string">"receiver has already been disposed."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用到了native层暂时不再继续往下深入。</p>
<p>如果没有使用垂直同步，会调用doFrame</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Choreographer.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startNanos;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// no work to do</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> intendedFrameTimeNanos = frameTimeNanos;</span><br><span class="line">        startNanos = System.nanoTime();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = startNanos - frameTimeNanos;</span><br><span class="line">        <span class="comment">//mFrameIntervalNanos代表每一帧的纳秒数</span></span><br><span class="line">        <span class="keyword">if</span> (jitterNanos &gt;= mFrameIntervalNanos) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> skippedFrames = jitterNanos / mFrameIntervalNanos;</span><br><span class="line">            <span class="comment">//计算需要跳过的帧数</span></span><br><span class="line">            <span class="keyword">if</span> (skippedFrames &gt;= SKIPPED_FRAME_WARNING_LIMIT) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">"Skipped "</span> + skippedFrames + <span class="string">" frames!  "</span></span><br><span class="line">                        + <span class="string">"The application may be doing too much work on its main thread."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos;</span><br><span class="line"></span><br><span class="line">            frameTimeNanos = startNanos - lastFrameOffset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (frameTimeNanos &lt; mLastFrameTimeNanos) &#123;</span><br><span class="line"></span><br><span class="line">            scheduleVsyncLocked();<span class="comment">//还是调用这个方法，会调用到native层</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mFrameInfo.setVsync(intendedFrameTimeNanos, frameTimeNanos);</span><br><span class="line">        mFrameScheduled = <span class="keyword">false</span>;</span><br><span class="line">        mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"Choreographer#doFrame"</span>);</span><br><span class="line">        AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);<span class="comment">//锁定状态</span></span><br><span class="line"></span><br><span class="line">        mFrameInfo.markInputHandlingStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">        mFrameInfo.markAnimationsStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);</span><br><span class="line">        <span class="comment">//之前队列中add的Callback的类型是CALLBACK_ANIMATION</span></span><br><span class="line">        mFrameInfo.markPerformTraversalsStart();</span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">        doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        AnimationUtils.unlockAnimationClock();<span class="comment">//解锁状态</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doCallbacks</span><span class="params">(<span class="keyword">int</span> callbackType, <span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">    CallbackRecord callbacks;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// We use "now" to determine when callbacks become due because it's possible</span></span><br><span class="line">        <span class="comment">// for earlier processing phases in a frame to post callbacks that should run</span></span><br><span class="line">        <span class="comment">// in a following phase, such as an input event that causes an animation to start.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = System.nanoTime();</span><br><span class="line">        callbacks = mCallbackQueues[callbackType].extractDueCallbacksLocked(</span><br><span class="line">                now / TimeUtils.NANOS_PER_MS);<span class="comment">//从队列中取出dueTime不大于now的callback</span></span><br><span class="line">        <span class="keyword">if</span> (callbacks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mCallbacksRunning = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the frame time if necessary when committing the frame.</span></span><br><span class="line">        <span class="comment">// We only update the frame time if we are more than 2 frames late reaching</span></span><br><span class="line">        <span class="comment">// the commit phase.  This ensures that the frame time which is observed by the</span></span><br><span class="line">        <span class="comment">// callbacks will always increase from one frame to the next and never repeat.</span></span><br><span class="line">        <span class="comment">// We never want the next frame's starting frame time to end up being less than</span></span><br><span class="line">        <span class="comment">// or equal to the previous frame's commit frame time.  Keep in mind that the</span></span><br><span class="line">        <span class="comment">// next frame has most likely already been scheduled by now so we play it</span></span><br><span class="line">        <span class="comment">// safe by ensuring the commit time is always at least one frame behind.</span></span><br><span class="line">        <span class="keyword">if</span> (callbackType == Choreographer.CALLBACK_COMMIT) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = now - frameTimeNanos;</span><br><span class="line">            Trace.traceCounter(Trace.TRACE_TAG_VIEW, <span class="string">"jitterNanos"</span>, (<span class="keyword">int</span>) jitterNanos);</span><br><span class="line">            <span class="keyword">if</span> (jitterNanos &gt;= <span class="number">2</span> * mFrameIntervalNanos) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos</span><br><span class="line">                        + mFrameIntervalNanos;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_JANK) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"Commit callback delayed by "</span> + (jitterNanos * <span class="number">0.000001f</span>)</span><br><span class="line">                            + <span class="string">" ms which is more than twice the frame interval of "</span></span><br><span class="line">                            + (mFrameIntervalNanos * <span class="number">0.000001f</span>) + <span class="string">" ms!  "</span></span><br><span class="line">                            + <span class="string">"Setting frame time to "</span> + (lastFrameOffset * <span class="number">0.000001f</span>)</span><br><span class="line">                            + <span class="string">" ms in the past."</span>);</span><br><span class="line">                    mDebugPrintNextFrameTimeDelta = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                frameTimeNanos = now - lastFrameOffset;</span><br><span class="line">                mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, CALLBACK_TRACE_TITLES[callbackType]);</span><br><span class="line">        <span class="keyword">for</span> (CallbackRecord c = callbacks; c != <span class="keyword">null</span>; c = c.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"RunCallback: type="</span> + callbackType</span><br><span class="line">                        + <span class="string">", action="</span> + c.action + <span class="string">", token="</span> + c.token</span><br><span class="line">                        + <span class="string">", latencyMillis="</span> + (SystemClock.uptimeMillis() - c.dueTime));</span><br><span class="line">            &#125;</span><br><span class="line">            c.run(frameTimeNanos);<span class="comment">//执行callback的run方法，这里的callback实际是CallbackRecord，它的成员action代表FrameCallback</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            mCallbacksRunning = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> CallbackRecord next = callbacks.next;</span><br><span class="line">                recycleCallbackLocked(callbacks);</span><br><span class="line">                callbacks = next;</span><br><span class="line">            &#125; <span class="keyword">while</span> (callbacks != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//CallbackRecord.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (token == FRAME_CALLBACK_TOKEN) &#123;</span><br><span class="line">            ((FrameCallback)action).doFrame(frameTimeNanos);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((Runnable)action).run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>回调了doFrame方法，因为token是FRAME_CALLBACK_TOKEN。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Choreographer.FrameCallback mFrameCallback = <span class="keyword">new</span> Choreographer.FrameCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</span><br><span class="line">        doAnimationFrame(getProvider().getFrameTime());</span><br><span class="line">        <span class="keyword">if</span> (mAnimationCallbacks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            getProvider().postFrameCallback(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>doFrame是在Choreographer所在的Looper线程中执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> currentTime = SystemClock.uptimeMillis();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mAnimationCallbacks.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> AnimationFrameCallback callback = mAnimationCallbacks.get(i);</span><br><span class="line">        <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isCallbackDue(callback, currentTime)) &#123;<span class="comment">//如果不延迟</span></span><br><span class="line">            callback.doAnimationFrame(frameTime);<span class="comment">//这里的callback就是ValueAnimator</span></span><br><span class="line">            <span class="keyword">if</span> (mCommitCallbacks.contains(callback)) &#123;</span><br><span class="line">                getProvider().postCommitCallback(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        commitAnimationFrame(callback, getProvider().getFrameTime());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cleanUpList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用到ValueAnimator的doAnimationFrame，是动画起作用的主要逻辑，会看AnimationHandler的mFrameCallback如果mAnimationCallbacks.size() &gt; 0会再调用MyFrameCallbackProvider的<br>postFrameCallback，这和一开始是一样的会在下一帧时间调用到ValueAnimator的doAnimationFrame，直到ValueAniator的endAnimation被调用，callback从AnimationHandler的mAnimationCallbacks中移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStartTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// First frame. If there is start delay, start delay count down will happen *after* this</span></span><br><span class="line">        <span class="comment">// frame.</span></span><br><span class="line">        mStartTime = mReversing ? frameTime : frameTime + (<span class="keyword">long</span>) (mStartDelay * sDurationScale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle pause/resume</span></span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        mPauseTime = frameTime;</span><br><span class="line">        removeAnimationCallback();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mResumed) &#123;</span><br><span class="line">        mResumed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mPauseTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Offset by the duration that the animation was paused</span></span><br><span class="line">            mStartTime += (frameTime - mPauseTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mRunning) &#123;</span><br><span class="line">        <span class="comment">// If not running, that means the animation is in the start delay phase of a forward</span></span><br><span class="line">        <span class="comment">// running animation. In the case of reversing, we want to run start delay in the end.</span></span><br><span class="line">        <span class="keyword">if</span> (mStartTime &gt; frameTime &amp;&amp; mSeekFraction == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// This is when no seek fraction is set during start delay. If developers change the</span></span><br><span class="line">            <span class="comment">// seek fraction during the delay, animation will start from the seeked position</span></span><br><span class="line">            <span class="comment">// right away.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If mRunning is not set by now, that means non-zero start delay,</span></span><br><span class="line">            <span class="comment">// no seeking, not reversing. At this point, start delay has passed.</span></span><br><span class="line">            mRunning = <span class="keyword">true</span>;</span><br><span class="line">            startAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mLastFrameTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSeekFraction &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> seekTime = (<span class="keyword">long</span>) (getScaledDuration() * mSeekFraction);</span><br><span class="line">            mStartTime = frameTime - seekTime;</span><br><span class="line">            mSeekFraction = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mStartTimeCommitted = <span class="keyword">false</span>; <span class="comment">// allow start time to be compensated for jank</span></span><br><span class="line">    &#125;</span><br><span class="line">    mLastFrameTime = frameTime;</span><br><span class="line">    <span class="comment">// The frame time might be before the start time during the first frame of</span></span><br><span class="line">    <span class="comment">// an animation.  The "current time" must always be on or after the start</span></span><br><span class="line">    <span class="comment">// time to avoid animating frames at negative time intervals.  In practice, this</span></span><br><span class="line">    <span class="comment">// is very rare and only happens when seeking backwards.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> currentTime = Math.max(frameTime, mStartTime);</span><br><span class="line">    <span class="keyword">boolean</span> finished = animateBasedOnTime(currentTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (finished) &#123;</span><br><span class="line">        endAnimation();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finished;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键方法是animateBasedOnTime</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">animateBasedOnTime</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mRunning) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> scaledDuration = getScaledDuration();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> fraction = scaledDuration &gt; <span class="number">0</span> ?</span><br><span class="line">                (<span class="keyword">float</span>)(currentTime - mStartTime) / scaledDuration : <span class="number">1f</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> lastFraction = mOverallFraction;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newIteration = (<span class="keyword">int</span>) fraction &gt; (<span class="keyword">int</span>) lastFraction;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> lastIterationFinished = (fraction &gt;= mRepeatCount + <span class="number">1</span>) &amp;&amp;</span><br><span class="line">                (mRepeatCount != INFINITE);</span><br><span class="line">        <span class="keyword">if</span> (scaledDuration == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 0 duration animator, ignore the repeat count and skip to the end</span></span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newIteration &amp;&amp; !lastIterationFinished) &#123;</span><br><span class="line">            <span class="comment">// Time to repeat</span></span><br><span class="line">            <span class="keyword">if</span> (mListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> numListeners = mListeners.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    mListeners.get(i).onAnimationRepeat(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastIterationFinished) &#123;</span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mOverallFraction = clampFraction(fraction);</span><br><span class="line">        <span class="keyword">float</span> currentIterationFraction = getCurrentIterationFraction(</span><br><span class="line">                mOverallFraction, mReversing);</span><br><span class="line">        animateValue(currentIterationFraction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又调用到了animateValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    fraction = mInterpolator.getInterpolation(fraction);<span class="comment">//插值器换算百分百</span></span><br><span class="line">    mCurrentFraction = fraction;</span><br><span class="line">    <span class="keyword">int</span> numValues = mValues.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">        mValues[i].calculateValue(fraction);<span class="comment">//PropertyValueHolder通过百分百计算value</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUpdateListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> numListeners = mUpdateListeners.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">            mUpdateListeners.get(i).onAnimationUpdate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">calculateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    Object value = mKeyframes.getValue(fraction);</span><br><span class="line">    mAnimatedValue = mConverter == <span class="keyword">null</span> ? value : mConverter.convert(value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//FloatKeyframeSet.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getFloatValue(fraction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//FloatEvaluator</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Float <span class="title">evaluate</span><span class="params">(<span class="keyword">float</span> fraction, Number startValue, Number endValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> startFloat = startValue.floatValue();</span><br><span class="line">    <span class="keyword">return</span> startFloat + fraction * (endValue.floatValue() - startFloat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getValue大体就是通过百分百、起点和终点来计算的。<br>计算后的值或者通过Converter转换或者直接使用。</p>
<p>ValueAnimator每一帧计算一次value就形成了动画，如果是ObjectAnimator还有一个target</p>
<p>animateValue会多调用setAnimatedValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAnimatedValue</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mProperty != <span class="keyword">null</span>) &#123;<span class="comment">//这里一般==null</span></span><br><span class="line">        mProperty.set(target, getAnimatedValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mSetter != <span class="keyword">null</span>) &#123;<span class="comment">//通过反射调用target的setter方法设置属性</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mTmpValueArray[<span class="number">0</span>] = getAnimatedValue();</span><br><span class="line">            mSetter.invoke(target, mTmpValueArray);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>属性动画通过多个关键值形成关键帧，start方法会触发在编舞者所在的Looper每一帧回调一次doAnimationFrame,会通过百分百计算value，也可能需要设置value给target。<br>所以属性动画实际上在动画过程中真正改变了target的属性值，这一点和View动画的只是通过Matrix变换显示效果是有本质区别的。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/07/Animation源码阅读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/07/Animation源码阅读/" itemprop="url">
                  Animation源码阅读
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-10-07 13:12:11 / Modified: 16:26:35" itemprop="dateCreated datePublished" datetime="2018-10-07T13:12:11+08:00">2018-10-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要分析android.view.animation.Animation及其相关类的源码。</p>
<h2 id="uml"><a href="#uml" class="headerlink" title="uml"></a>uml</h2><p><a href="http://www.plantuml.com/plantuml/svg/5Sin3i8m34RXlQSe5uY1WO6fLp6fQIqbJcN_5XoVCZtfITyIO4VsDbtKQijLqjky0qSyYPm_PLFi-SeGhyCWXb97fot7zts_tXvqd3YeSq2SsBGpT5ZvxsaHMy_-0000" target="_blank" rel="noopener">Animation UML</a></p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">android:shareInterpolator</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scale</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/accelerate_decelerate_interpolator"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromXScale</span>=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toXScale</span>=<span class="string">"1.4"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fromYScale</span>=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:toYScale</span>=<span class="string">"0.6"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:pivotX</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:pivotY</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fillAfter</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:duration</span>=<span class="string">"700"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span> <span class="attr">android:interpolator</span>=<span class="string">"@android:anim/decelerate_interpolator"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scale</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:fromXScale</span>=<span class="string">"1.4"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:toXScale</span>=<span class="string">"0.0"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:fromYScale</span>=<span class="string">"0.6"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:toYScale</span>=<span class="string">"0.0"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:pivotX</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:pivotY</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:startOffset</span>=<span class="string">"700"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:duration</span>=<span class="string">"400"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:fillBefore</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rotate</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:fromDegrees</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:toDegrees</span>=<span class="string">"-45"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:toYScale</span>=<span class="string">"0.0"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:pivotX</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:pivotY</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:startOffset</span>=<span class="string">"700"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:duration</span>=<span class="string">"400"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ImageView spaceshipImage = (ImageView) findViewById(R.id.spaceshipImage);</span><br><span class="line">Animation hyperspaceJumpAnimation = AnimationUtils.loadAnimation(<span class="keyword">this</span>, R.anim.hyperspace_jump);</span><br><span class="line">spaceshipImage.startAnimation(hyperspaceJumpAnimation);</span><br></pre></td></tr></table></figure>
<h2 id="源码追溯"><a href="#源码追溯" class="headerlink" title="源码追溯"></a>源码追溯</h2><p>View的startAnimation方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAnimation</span><span class="params">(Animation animation)</span> </span>&#123;</span><br><span class="line">        animation.setStartTime(Animation.START_ON_FIRST_FRAME);</span><br><span class="line">        setAnimation(animation);</span><br><span class="line">        invalidateParentCaches();</span><br><span class="line">        invalidate(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Animation的setStartTime</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartTime</span><span class="params">(<span class="keyword">long</span> startTimeMillis)</span> </span>&#123;</span><br><span class="line">        mStartTime = startTimeMillis;</span><br><span class="line">        mStarted = mEnded = <span class="keyword">false</span>;</span><br><span class="line">        mCycleFlip = <span class="keyword">false</span>;</span><br><span class="line">        mRepeated = <span class="number">0</span>;</span><br><span class="line">        mMore = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>View的setAnimation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnimation</span><span class="params">(Animation animation)</span> </span>&#123;</span><br><span class="line">        mCurrentAnimation = animation;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (animation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If the screen is off assume the animation start time is now instead of</span></span><br><span class="line">            <span class="comment">// the next frame we draw. Keeping the START_ON_FIRST_FRAME start time</span></span><br><span class="line">            <span class="comment">// would cause the animation to start when the screen turns back on</span></span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mDisplayState == Display.STATE_OFF</span><br><span class="line">                    &amp;&amp; animation.getStartTime() == Animation.START_ON_FIRST_FRAME) &#123;</span><br><span class="line">                animation.setStartTime(AnimationUtils.currentAnimationTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            animation.reset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>View的invalidate方法最后会触发ViewRootImpl的performTraversals，这个方法超级长<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法遍历View执行测量、布局、绘制流程，我们只看跟动画有关的绘制流程。<br>通过ViewGroup的dispatchDraw调用child的draw</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">draw</span><span class="params">(Canvas canvas, ViewGroup parent, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Animation a = getAnimation();</span><br><span class="line">       <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">           more = applyLegacyAnimation(parent, drawingTime, a, scalingRequired);</span><br><span class="line">           concatMatrix = a.willChangeTransformationMatrix();</span><br><span class="line">           <span class="keyword">if</span> (concatMatrix) &#123;</span><br><span class="line">               mPrivateFlags3 |= PFLAG3_VIEW_IS_ANIMATING_TRANSFORM;</span><br><span class="line">           &#125;</span><br><span class="line">           transformToApply = parent.getChildTransformation();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">applyLegacyAnimation</span><span class="params">(ViewGroup parent, <span class="keyword">long</span> drawingTime,</span></span></span><br><span class="line"><span class="function"><span class="params">        Animation a, <span class="keyword">boolean</span> scalingRequired)</span> </span>&#123;</span><br><span class="line">    Transformation invalidationTransform;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags = parent.mGroupFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> initialized = a.isInitialized();</span><br><span class="line">    <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">        a.initialize(mRight - mLeft, mBottom - mTop, parent.getWidth(), parent.getHeight());</span><br><span class="line">        a.initializeInvalidateRegion(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop);</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span>) a.setListenerHandler(mAttachInfo.mHandler);</span><br><span class="line">        onAnimationStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Transformation t = parent.getChildTransformation();</span><br><span class="line">    <span class="keyword">boolean</span> more = a.getTransformation(drawingTime, t, <span class="number">1f</span>);</span><br><span class="line">    <span class="keyword">if</span> (scalingRequired &amp;&amp; mAttachInfo.mApplicationScale != <span class="number">1f</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parent.mInvalidationTransformation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            parent.mInvalidationTransformation = <span class="keyword">new</span> Transformation();</span><br><span class="line">        &#125;</span><br><span class="line">        invalidationTransform = parent.mInvalidationTransformation;</span><br><span class="line">        a.getTransformation(drawingTime, invalidationTransform, <span class="number">1f</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        invalidationTransform = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (more) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!a.willChangeBounds()) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; (ViewGroup.FLAG_OPTIMIZE_INVALIDATE | ViewGroup.FLAG_ANIMATION_DONE)) ==</span><br><span class="line">                    ViewGroup.FLAG_OPTIMIZE_INVALIDATE) &#123;</span><br><span class="line">                parent.mGroupFlags |= ViewGroup.FLAG_INVALIDATE_REQUIRED;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; ViewGroup.FLAG_INVALIDATE_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// The child need to draw an animation, potentially offscreen, so</span></span><br><span class="line">                <span class="comment">// make sure we do not cancel invalidate requests</span></span><br><span class="line">                parent.mPrivateFlags |= PFLAG_DRAW_ANIMATION;</span><br><span class="line">                parent.invalidate(mLeft, mTop, mRight, mBottom);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (parent.mInvalidateRegion == <span class="keyword">null</span>) &#123;</span><br><span class="line">                parent.mInvalidateRegion = <span class="keyword">new</span> RectF();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> RectF region = parent.mInvalidateRegion;</span><br><span class="line">            a.getInvalidateRegion(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, region,</span><br><span class="line">                    invalidationTransform);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The child need to draw an animation, potentially offscreen, so</span></span><br><span class="line">            <span class="comment">// make sure we do not cancel invalidate requests</span></span><br><span class="line">            parent.mPrivateFlags |= PFLAG_DRAW_ANIMATION;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> left = mLeft + (<span class="keyword">int</span>) region.left;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> top = mTop + (<span class="keyword">int</span>) region.top;</span><br><span class="line">            parent.invalidate(left, top, left + (<span class="keyword">int</span>) (region.width() + .<span class="number">5f</span>),</span><br><span class="line">                    top + (<span class="keyword">int</span>) (region.height() + .<span class="number">5f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>View的applyLegacyAnimation会调用Animation的getTransformation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getTransformation</span><span class="params">(<span class="keyword">long</span> currentTime, Transformation outTransformation)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mStartTime == -<span class="number">1</span>) &#123;</span><br><span class="line">           mStartTime = currentTime;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">long</span> startOffset = getStartOffset();</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">long</span> duration = mDuration;</span><br><span class="line">       <span class="keyword">float</span> normalizedTime;</span><br><span class="line">       <span class="keyword">if</span> (duration != <span class="number">0</span>) &#123;</span><br><span class="line">           normalizedTime = ((<span class="keyword">float</span>) (currentTime - (mStartTime + startOffset))) /</span><br><span class="line">                   (<span class="keyword">float</span>) duration;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// time is a step-change with a zero duration</span></span><br><span class="line">           normalizedTime = currentTime &lt; mStartTime ? <span class="number">0.0f</span> : <span class="number">1.0f</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> expired = normalizedTime &gt;= <span class="number">1.0f</span> || isCanceled();</span><br><span class="line">       mMore = !expired;<span class="comment">//是否结束</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!mFillEnabled) normalizedTime = Math.max(Math.min(normalizedTime, <span class="number">1.0f</span>), <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> ((normalizedTime &gt;= <span class="number">0.0f</span> || mFillBefore) &amp;&amp; (normalizedTime &lt;= <span class="number">1.0f</span> || mFillAfter)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!mStarted) &#123;</span><br><span class="line">               fireAnimationStart();</span><br><span class="line">               mStarted = <span class="keyword">true</span>;</span><br><span class="line">               <span class="keyword">if</span> (NoImagePreloadHolder.USE_CLOSEGUARD) &#123;</span><br><span class="line">                   guard.open(<span class="string">"cancel or detach or getTransformation"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mFillEnabled) normalizedTime = Math.max(Math.min(normalizedTime, <span class="number">1.0f</span>), <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mCycleFlip) &#123;</span><br><span class="line">               normalizedTime = <span class="number">1.0f</span> - normalizedTime;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">float</span> interpolatedTime = mInterpolator.getInterpolation(normalizedTime);<span class="comment">//这里就是Interpolator起作用的地方</span></span><br><span class="line">           applyTransformation(interpolatedTime, outTransformation);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (expired) &#123;<span class="comment">//结束</span></span><br><span class="line">           <span class="keyword">if</span> (mRepeatCount == mRepeated || isCanceled()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!mEnded) &#123;</span><br><span class="line">                   mEnded = <span class="keyword">true</span>;</span><br><span class="line">                   guard.close();</span><br><span class="line">                   fireAnimationEnd();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (mRepeatCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   mRepeated++;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mRepeatMode == REVERSE) &#123;</span><br><span class="line">                   mCycleFlip = !mCycleFlip;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               mStartTime = -<span class="number">1</span>;</span><br><span class="line">               mMore = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">               fireAnimationRepeat();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!mMore &amp;&amp; mOneMoreTime) &#123;</span><br><span class="line">           mOneMoreTime = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;<span class="comment">//没有结束返回true</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> mMore;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后会调用applyTransformation，这个方法设置Transformation的Matrix，这里的outTransformation就是ViewGroup的mChildTransformation。<br>应用Matrix<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (transformToApply != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (concatMatrix) &#123;</span><br><span class="line">        <span class="keyword">if</span> (drawingWithRenderNode) &#123;</span><br><span class="line">            renderNode.setAnimationMatrix(transformToApply.getMatrix());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Undo the scroll translation, apply the transformation matrix,</span></span><br><span class="line">            <span class="comment">// then redo the scroll translate to get the correct result.</span></span><br><span class="line">            canvas.translate(-transX, -transY);</span><br><span class="line">            canvas.concat(transformToApply.getMatrix());</span><br><span class="line">            canvas.translate(transX, transY);</span><br><span class="line">        &#125;</span><br><span class="line">        parent.mGroupFlags |= ViewGroup.FLAG_CLEAR_TRANSFORMATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> transformAlpha = transformToApply.getAlpha();</span><br><span class="line">    <span class="keyword">if</span> (transformAlpha &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        alpha *= transformAlpha;</span><br><span class="line">        parent.mGroupFlags |= ViewGroup.FLAG_CLEAR_TRANSFORMATION;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Animation的getTransformation返回true表示动画没有结束，会再次出发遍历View并重新绘制，在下一次同步信号到来时，也就会再一次改变Transformation的Matrix，然后再应用Matrix。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Animation的关键就是View每一帧会应用Transformation的Matrix，而每一帧的视图遍历会通过Animation的getTransformation方法改变Transformation的Matrix，这就形成了动画。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/Glide源码阅读2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GuoXf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/Glide源码阅读2/" itemprop="url">
                  Glide源码阅读2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-09-24 18:41:35 / Modified: 20:10:45" itemprop="dateCreated datePublished" datetime="2018-09-24T18:41:35+08:00">2018-09-24</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文继续分析Glide源码，主要关注一下Engine</p>
<h2 id="源码追溯"><a href="#源码追溯" class="headerlink" title="源码追溯"></a>源码追溯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">      Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">      Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">      Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">      Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">      ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line"></span><br><span class="line">    EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">        resourceClass, transcodeClass, options);</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(active, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">      current.addCallback(cb);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineJob&lt;R&gt; engineJob =</span><br><span class="line">        engineJobFactory.build(</span><br><span class="line">            key,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache);</span><br><span class="line"></span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            key,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            options,</span><br><span class="line">            engineJob);</span><br><span class="line"></span><br><span class="line">    jobs.put(key, engineJob);</span><br><span class="line"></span><br><span class="line">    engineJob.addCallback(cb);</span><br><span class="line">    engineJob.start(decodeJob);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到首先会从激活的资源中获取，获取不到会去缓存中获取，分别是loadFromActiveResources<br>和loadFromCache</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    EngineResource&lt;?&gt; active = activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      active.acquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>activeResources内部有一个HashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cached.acquire();</span><br><span class="line">      activeResources.activate(key, cached);<span class="comment">//从缓存中获取出来就将其放入激活的HashMap中，而且在cache中是移除的</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">    Resource&lt;?&gt; cached = cache.remove(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> EngineResource&lt;?&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">      result = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">      <span class="comment">// Save an object allocation if we've cached an EngineResource (the typical case).</span></span><br><span class="line">      result = (EngineResource&lt;?&gt;) cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = <span class="keyword">new</span> EngineResource&lt;&gt;(cached, <span class="keyword">true</span> <span class="comment">/*isMemoryCacheable*/</span>, <span class="keyword">true</span> <span class="comment">/*isRecyclable*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里的cache就是在初始化Glide时创建的LruResourceCache， 它的内部是一个LinkedHashMap实现的LruCache。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;T, Y&gt; cache = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">100</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>LinkedHashMap和HashMap的主要区别是它整个是一个链表，可以通过访问顺序来调整元素的顺序，很适合做lrucache</p>
<p>在从激活资源中移除时又会放回到cache中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReleased</span><span class="params">(Key cacheKey, EngineResource&lt;?&gt; resource)</span> </span>&#123;</span><br><span class="line">    Util.assertMainThread();</span><br><span class="line">    activeResources.deactivate(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (resource.isCacheable()) &#123;</span><br><span class="line">      cache.put(cacheKey, resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      resourceRecycler.recycle(resource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>所以激活资源和lrucache实际上相当于是两级缓存。</p>
<p>如果在两级缓存中都没有，就需要实际的去加载了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">engineJob.start(decodeJob);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache()</span><br><span class="line">        ? diskCacheExecutor</span><br><span class="line">        : getActiveSourceExecutor();</span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>解码也首先去判断是否从diskcache中去解码资源，以此决定用哪个Excutor。<br>主要区别是线程池的核心线程数和最大线程数以及任务队列。</p>
<p>接下来看下decodejob</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">     <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">       stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">       currentGenerator = getNextGenerator();</span><br><span class="line">       runGenerators();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">       runGenerators();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">       decodeFromRetrievedData();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">     <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> SOURCE:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">case</span> FINISHED:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   currentThread = Thread.currentThread();</span><br><span class="line">   startFetchTime = LogTime.getLogTime();</span><br><span class="line">   <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">   <span class="keyword">while</span> (!isCancelled &amp;&amp; currentGenerator != <span class="keyword">null</span></span><br><span class="line">       &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">     stage = getNextStage(stage);</span><br><span class="line">     currentGenerator = getNextGenerator();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">       reschedule();</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">     notifyFailed();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">enum</span> Stage &#123;</span><br><span class="line">   <span class="comment">/** The initial stage. */</span></span><br><span class="line">   INITIALIZE,</span><br><span class="line">   <span class="comment">/** Decode from a cached resource. */</span></span><br><span class="line">   RESOURCE_CACHE,</span><br><span class="line">   <span class="comment">/** Decode from cached source data. */</span></span><br><span class="line">   DATA_CACHE,</span><br><span class="line">   <span class="comment">/** Decode from retrieved source. */</span></span><br><span class="line">   SOURCE,</span><br><span class="line">   <span class="comment">/** Encoding transformed resources after a successful load. */</span></span><br><span class="line">   ENCODE,</span><br><span class="line">   <span class="comment">/** No more viable stages. */</span></span><br><span class="line">   FINISHED,</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这一部分看上去挺复杂的，简单的理解为还是逐个从各级缓存decode，最终通过实际的图片资源decode。</p>
<p>假设已经加载成功，并且还都已经做了缓存，会回调Target,这里是ImageViewTarget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(@NonNull Z resource, @Nullable Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line">      setResourceInternal(resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      maybeUpdateAnimatable(resource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>也就是会调用到View的setXXX方法来设置图片，或者启动动画。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过对Glide源码的简单分析，可以看到主要的设计思路是围绕着缓存展开的，对于其中很多细节没有深入的挖掘，但对于Glide的源码有一个大概的认识。<br>对于LruCache加深了认识。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">GuoXf</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GuoXf</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
